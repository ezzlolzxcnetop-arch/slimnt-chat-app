<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>slax_</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Конфигурация Tailwind для кастомной цветовой палитры Revent -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Основной темный фон (глубокий индиго/уголь)
                        'revent-dark': '#1e1f29',
                        // Фон боковой панели / чата (чуть светлее)
                        'revent-panel': '#282a36',
                        // Основной акцентный цвет (кибер-синий/циан)
                        'revent-accent': '#00bfff', // Яркий циан
                        // Вторичный акцент для активных элементов
                        'revent-active': '#4c5885',
                        // Цвет текста
                        'revent-text': '#e0e0e0',
                        // Цвет более тусклого текста/разделителей
                        'revent-subtle': '#8f9ba8',
                        // Цвет для ошибок/предупреждений
                        'revent-error': '#ff6347', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Стиль для кастомного скроллбара, чтобы соответствовать темной теме */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #282a36; /* revent-panel */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4c5885; /* revent-active */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #00bfff; /* revent-accent */
        }
        /* Стили для предотвращения Cumulative Layout Shift (CLS) */
        #messages, #system-messages {
            min-height: 50px; /* Обеспечиваем минимальную высоту */
        }
        
    </style>
</head>
<body class="bg-revent-dark text-revent-text font-sans h-screen flex flex-col antialiased overflow-hidden">

    <!-- Главный контейнер (Сетка) -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Боковая панель (Список каналов / Пользователей) -->
        <div id="sidebar" class="w-20 sm:w-64 bg-revent-panel p-4 flex-shrink-0 overflow-y-auto custom-scrollbar transition-all duration-300">
            <h1 class="text-lg font-bold text-revent-accent mb-4 hidden sm:block">Revent Chat</h1>
            <div id="user-info" class="mb-4 text-sm break-words hidden sm:block">
                <p id="current-username" class="font-semibold">Гость</p>
                <p id="current-user-id" class="text-xs text-revent-subtle overflow-hidden overflow-ellipsis whitespace-nowrap">ID: Ожидание входа...</p>
            </div>
            <hr class="border-revent-active mb-4 hidden sm:block">
            <h2 class="text-xs uppercase font-semibold text-revent-subtle mb-2 hidden sm:block">Пользователи</h2>
            <ul id="active-users-list" class="space-y-1">
                <!-- Список пользователей будет здесь -->
                <li class="text-revent-subtle text-sm">Нет других пользователей.</li>
            </ul>
        </div>

        <!-- Контейнер Чата -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Заголовок Чата -->
            <header class="bg-revent-panel p-4 shadow-lg flex items-center justify-between flex-shrink-0">
                <h2 class="text-xl font-bold">Общий Чат</h2>
                <button id="auth-button" class="bg-revent-accent hover:bg-opacity-90 text-revent-dark font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                    Войти / Регистрация
                </button>
            </header>

            <!-- Сообщения Чата -->
            <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3">
                <div id="messages" class="flex flex-col space-y-3 pb-2">
                    <!-- Сообщения будут здесь -->
                </div>
                <!-- Системные сообщения (для уведомлений/ошибок) -->
                <div id="system-messages" class="space-y-1 text-sm text-center text-revent-error">
                    <!-- Системные сообщения будут здесь -->
                </div>
            </div>

            <!-- Форма ввода Сообщения -->
            <footer class="bg-revent-panel p-4 flex-shrink-0">
                <div id="message-input-form" class="flex space-x-3 hidden">
                    <input type="text" id="message-input" placeholder="Написать сообщение..." 
                           class="flex-1 p-3 rounded-lg bg-revent-dark border border-revent-active focus:border-revent-accent focus:ring focus:ring-revent-accent focus:ring-opacity-50 transition duration-150 text-revent-text outline-none" 
                           maxlength="500">
                    <button id="send-button" class="bg-revent-accent hover:bg-opacity-90 text-revent-dark font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md flex-shrink-0">
                        Отправить
                    </button>
                </div>
                <div id="auth-required-message" class="text-center text-revent-subtle p-3">
                    Пожалуйста, войдите или зарегистрируйтесь для отправки сообщений.
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Модальное окно Аутентификации (Кастомный Вход/Регистрация) -->
    <div id="auth-modal" class="fixed inset-0 bg-revent-dark bg-opacity-90 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-revent-panel p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 id="auth-title" class="text-2xl font-bold mb-6 text-revent-accent text-center">Вход</h2>
            <p id="auth-feedback" class="text-revent-error text-sm mb-4 hidden"></p>
            
            <form id="auth-form"> 
                <div class="mb-4">
                    <label for="auth-username" class="block text-sm font-medium text-revent-text mb-1">Логин</label>
                    <input type="text" id="auth-username" required minlength="3" maxlength="20"
                           class="w-full p-3 rounded-lg bg-revent-dark border border-revent-active focus:border-revent-accent outline-none text-revent-text">
                </div>
                <div class="mb-6">
                    <label for="auth-password" class="block text-sm font-medium text-revent-text mb-1">Пароль</label>
                    <input type="password" id="auth-password" required minlength="6"
                           class="w-full p-3 rounded-lg bg-revent-dark border border-revent-active focus:border-revent-accent outline-none text-revent-text">
                </div>
                
                <button type="submit" id="auth-submit-button" class="w-full bg-revent-accent hover:bg-opacity-90 text-revent-dark font-bold py-3 px-4 rounded-lg transition duration-200">
                    Войти
                </button>
            </form>
            
            <button id="toggle-auth-mode" class="mt-4 w-full text-sm text-revent-subtle hover:text-revent-accent transition duration-200">
                Нет аккаунта? <span id="auth-mode-text" class="font-semibold">Зарегистрироваться</span>
            </button>
            <button id="close-modal-button" class="absolute top-4 right-4 text-revent-subtle hover:text-revent-text text-xl">
                &times;
            </button>
        </div>
    </div>


    <!-- Firebase imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ИЗМЕНЕНИЕ: Добавлена функция getDoc
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, setDoc, onSnapshot, orderBy, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Включаем логирование для отладки Firestore
        setLogLevel('debug');

        // Глобальные переменные Firebase, как предписано средой
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let firebaseUserId = null; // ID пользователя, выданный Firebase
        let appUsername = null;   // Логин, выбранный пользователем (ключ для кастомной аутентификации)
        let isAuthReady = false;
        let isRegisterMode = false;

        // --- Утилиты ---

        // Утилита для хэширования пароля (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashedPassword;
        }

        // --- Firestore Пути ---
        const USER_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;
        const MESSAGE_COLLECTION_PATH = `/artifacts/${appId}/public/data/messages`;
        
        // --- DOM Элементы ---
        const authModal = document.getElementById('auth-modal');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const authModeText = document.getElementById('auth-mode-text');
        const authFeedback = document.getElementById('auth-feedback');
        const closeModalButton = document.getElementById('close-modal-button');
        const authButton = document.getElementById('auth-button');

        const messageInputForm = document.getElementById('message-input-form');
        const authRequiredMessage = document.getElementById('auth-required-message');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const messagesContainer = document.getElementById('messages');
        const systemMessagesContainer = document.getElementById('system-messages');
        const currentUsernameElement = document.getElementById('current-username');
        const currentUserIdElement = document.getElementById('current-user-id');
        const activeUsersList = document.getElementById('active-users-list');

        // --- Вспомогательные функции DOM ---

        function showAuthModal() {
            authModal.classList.remove('hidden');
        }

        function hideAuthModal() {
            authModal.classList.add('hidden');
        }

        function setAuthFeedback(message, isError = true) {
            authFeedback.textContent = message;
            authFeedback.className = `text-sm mb-4 ${isError ? 'text-revent-error' : 'text-revent-accent'}`;
            authFeedback.classList.remove('hidden');
        }

        function clearAuthFeedback() {
            authFeedback.classList.add('hidden');
            authFeedback.textContent = '';
        }

        function updateUIForAuthenticatedUser() {
            if (appUsername) {
                currentUsernameElement.textContent = appUsername;
                currentUserIdElement.textContent = `ID: ${firebaseUserId.substring(0, 8)}...`;
                authButton.textContent = 'Выйти';
                authButton.onclick = handleLogout;
                
                messageInputForm.classList.remove('hidden');
                authRequiredMessage.classList.add('hidden');
                hideAuthModal();
            } else {
                currentUsernameElement.textContent = 'Гость';
                currentUserIdElement.textContent = 'ID: Ожидание входа...';
                authButton.textContent = 'Войти / Регистрация';
                authButton.onclick = showAuthModal;
                
                messageInputForm.classList.add('hidden');
                authRequiredMessage.classList.remove('hidden');
            }
        }
        
        function addSystemMessageToDOM(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'text-revent-error py-1 px-3 bg-revent-panel/50 rounded-lg shadow-inner animate-pulse';
            messageEl.textContent = message;
            systemMessagesContainer.prepend(messageEl);
            // Удаляем сообщение через 5 секунд
            setTimeout(() => messageEl.remove(), 5000); 
        }

        // --- Логика Аутентификации (Кастомная) ---
        
        async function handleRegistration(username, password) {
            clearAuthFeedback();
            authSubmitButton.disabled = true;
            authSubmitButton.textContent = 'Регистрация...';

            try {
                // 1. Проверка существования пользователя (используя getDoc)
                const userDocRef = doc(db, USER_COLLECTION_PATH, username);
                const userDoc = await getDoc(userDocRef); // <-- Теперь getDoc определен

                if (userDoc.exists()) {
                    setAuthFeedback('Пользователь с таким логином уже существует.', true);
                    return false;
                }

                // 2. Хэширование пароля
                const hashedPassword = await hashPassword(password);
                
                // 3. Создание нового документа пользователя, используя username как ID документа
                await setDoc(userDocRef, {
                    username: username,
                    hashedPassword: hashedPassword,
                    createdAt: serverTimestamp(),
                    firebaseUid: firebaseUserId // Сохраняем UID Firebase
                });

                setAuthFeedback('Регистрация успешна! Теперь выполните вход.', false);
                // Переключаемся на режим входа
                toggleAuthModeButton.click(); 
                return true;

            } catch (e) {
                console.error("Ошибка регистрации:", e);
                addSystemMessageToDOM('❌ Ошибка регистрации. Проверьте консоль.');
                setAuthFeedback('Ошибка регистрации. Попробуйте снова.', true);
                return false;
            } finally {
                authSubmitButton.disabled = false;
                authSubmitButton.textContent = 'Зарегистрироваться';
            }
        }


        async function handleLogin(username, password) {
            clearAuthFeedback();
            authSubmitButton.disabled = true;
            authSubmitButton.textContent = 'Вход...';

            try {
                // 1. Поиск пользователя по логину (username является ID документа)
                const userDocRef = doc(db, USER_COLLECTION_PATH, username);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    setAuthFeedback('Неверный логин или пароль.', true);
                    return false;
                }

                const userData = userDoc.data();
                
                // 2. Хэширование введенного пароля
                const enteredHashedPassword = await hashPassword(password);

                // 3. Сравнение хэшей
                if (enteredHashedPassword !== userData.hashedPassword) {
                    setAuthFeedback('Неверный логин или пароль.', true);
                    return false;
                }

                // 4. Успешный вход: устанавливаем логин приложения
                appUsername = username;
                updateUIForAuthenticatedUser();
                
                // После успешного входа перезапускаем слушателей сообщений/пользователей
                setupFirestoreListeners(); 

                return true;

            } catch (e) {
                console.error("Ошибка входа:", e);
                addSystemMessageToDOM('❌ Ошибка входа. Проверьте консоль.');
                setAuthFeedback('Ошибка входа. Проверьте подключение или попробуйте позже.', true);
                return false;
            } finally {
                authSubmitButton.disabled = false;
                authSubmitButton.textContent = 'Войти';
            }
        }

        function handleAuthSubmit() {
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value;

            if (username.length < 3 || password.length < 6) {
                setAuthFeedback('Логин должен быть 3+ символа, пароль - 6+ символов.', true);
                return;
            }

            if (isRegisterMode) {
                handleRegistration(username, password);
            } else {
                handleLogin(username, password);
            }
        }

        function handleLogout() {
            appUsername = null;
            updateUIForAuthenticatedUser();
            addSystemMessageToDOM('Вы вышли из системы.');
            // Сброс сообщений и пользователей, так как пользователь "не известен"
            messagesContainer.innerHTML = '';
            activeUsersList.innerHTML = '<li class="text-revent-subtle text-sm">Нет других пользователей.</li>';
            
            // Переключаем обратно на модальное окно для входа
            showAuthModal();
        }

        // --- Обработчики DOM событий ---

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleAuthSubmit();
        });


        toggleAuthModeButton.addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            authTitle.textContent = isRegisterMode ? 'Регистрация' : 'Вход';
            authModeText.textContent = isRegisterMode ? 'Войти' : 'Зарегистрироваться';
            authSubmitButton.textContent = isRegisterMode ? 'Зарегистрироваться' : 'Войти';
            clearAuthFeedback();
        });

        authButton.addEventListener('click', () => {
             // Эта кнопка либо открывает модальное окно, либо обрабатывает выход,
             // логика прописана в updateUIForAuthenticatedUser
             if (!appUsername) {
                showAuthModal();
             } else {
                handleLogout();
             }
        });
        
        closeModalButton.addEventListener('click', hideAuthModal);
        
        // --- Логика Чата (Отправка) ---
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            
            if (!appUsername) {
                addSystemMessageToDOM('❌ Вы должны войти, чтобы отправлять сообщения.');
                showAuthModal();
                return;
            }

            if (text === '') {
                return;
            }
            
            try {
                // Сохраняем сообщение в публичной коллекции
                await addDoc(collection(db, MESSAGE_COLLECTION_PATH), {
                    username: appUsername, // Используем кастомный логин
                    text: text,
                    timestamp: serverTimestamp(),
                    firebaseUid: firebaseUserId,
                    avatarColor: getColorHash(appUsername),
                });
                
                messageInput.value = '';
                
            } catch (e) {
                console.error("Ошибка отправки сообщения:", e);
                addSystemMessageToDOM('❌ Не удалось отправить сообщение. Проверьте консоль.');
            }
        }
        
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // --- Утилиты для Чата ---

        function getColorHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            // Обеспечиваем, чтобы цвет был достаточно темным/светлым для контраста
            const r = parseInt(color.substring(1, 3), 16);
            const g = parseInt(color.substring(3, 5), 16);
            const b = parseInt(color.substring(5, 7), 16);
            
            // Если слишком светло, затемняем
            if ((r*0.299 + g*0.587 + b*0.114) > 120) {
                return `#${Math.floor(r*0.5).toString(16).padStart(2, '0')}${Math.floor(g*0.5).toString(16).padStart(2, '0')}${Math.floor(b*0.5).toString(16).padStart(2, '0')}`;
            }
            return color;
        }

        function displayMessage(data) {
            const div = document.createElement('div');
            // Определяем, является ли это сообщение текущего пользователя
            const isCurrentUser = data.username === appUsername;
            
            // Обновляем класс для flex-контейнера в зависимости от отправителя
            // self-end перемещает всю группу к правому краю, flex-row-reverse меняет местами аватар и сообщение
            div.className = `flex items-start space-x-3 group ${isCurrentUser ? 'self-end flex-row-reverse' : ''}`;
            
            const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
            
            // Обновляем классы для сообщения и аватара
            const messageClasses = isCurrentUser 
                ? 'bg-revent-active rounded-br-none' 
                : 'bg-revent-panel rounded-tl-none';
            
            const avatarColor = data.avatarColor || getColorHash(data.username);
            const avatarMargin = isCurrentUser ? 'ml-3' : 'mr-3'; // Для обратного порядка

            div.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-md ${avatarMargin}" style="background-color: ${avatarColor}; color: ${isLight(avatarColor) ? '#000' : '#FFF'};">
                    ${data.username.substring(0, 1).toUpperCase()}
                </div>
                
                <!-- 
                    КЛЮЧЕВОЕ ИЗМЕНЕНИЕ: 
                    1. max-w-full - контейнер занимает все оставшееся место.
                    2. flex flex-col - чтобы его содержимое (заголовок и сообщение) располагалось вертикально.
                    3. items-end / items-start - чтобы выровнять содержимое контейнера вправо или влево.
                -->
                <div class="max-w-full flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}"> 
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-revent-text text-sm">${data.username}</span>
                        <span class="text-xs text-revent-subtle">${time}</span>
                    </div>
                    <!-- 
                        4. w-fit - заставляет блок <p> сжиматься до ширины текста.
                        5. max-w-lg - ограничивает максимальную ширину.
                        Убраны ml-auto/ml-0, так как выравнивание теперь контролируется родительским div (items-end/start).
                    -->
                    <p class="mt-1 p-3 rounded-xl max-w-lg w-fit whitespace-pre-wrap break-words text-revent-text shadow-md ${messageClasses}">
                        ${data.text}
                    </p>
                </div>
            `;
            
            // Вставляем новый элемент в конец списка
            messagesContainer.appendChild(div);
            // Прокручиваем до последнего сообщения
            messagesContainer.parentElement.scrollTop = messagesContainer.parentElement.scrollHeight;
        }

        function isLight(color) {
            const r = parseInt(color.substring(1, 3), 16);
            const g = parseInt(color.substring(3, 5), 16);
            const b = parseInt(color.substring(5, 7), 16);
            return (r * 0.299 + g * 0.587 + b * 0.114) > 186;
        }

        // --- Слушатели Firestore ---
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;

        function setupFirestoreListeners() {
            if (!isAuthReady || !appUsername) return; // Нужна готовность Firebase и успешный вход в приложение

            // Отключаем предыдущих слушателей, если они есть
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeUsers) unsubscribeUsers();

            // 1. Слушатель Сообщений
            const messagesQuery = query(collection(db, MESSAGE_COLLECTION_PATH), orderBy('timestamp', 'asc'));
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const fragment = document.createDocumentFragment();
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    displayMessage(doc.data());
                });
                // Прокручиваем до последнего сообщения после загрузки
                messagesContainer.parentElement.scrollTop = messagesContainer.parentElement.scrollHeight;
            }, (error) => {
                console.error("Ошибка при получении сообщений:", error);
                addSystemMessageToDOM('❌ Ошибка загрузки сообщений. Проверьте права доступа.');
            });

            // 2. Слушатель Пользователей (активные пользователи - те, кто зарегистрирован)
            const usersQuery = collection(db, USER_COLLECTION_PATH);
            unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                activeUsersList.innerHTML = '';
                const uniqueUsers = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Используем username для отображения
                    if (data.username && !uniqueUsers[data.username]) {
                        uniqueUsers[data.username] = true;
                        const listItem = document.createElement('li');
                        const statusClass = data.username === appUsername ? 'text-revent-accent font-bold' : 'text-revent-text';
                        const statusIndicator = data.username === appUsername ? ' (Вы)' : '';

                        listItem.className = `text-sm transition-colors duration-150 p-1 rounded-lg ${statusClass}`;
                        listItem.innerHTML = `<span class="inline-block w-2 h-2 rounded-full mr-2 bg-green-500"></span>${data.username}${statusIndicator}`;
                        activeUsersList.appendChild(listItem);
                    }
                });
                
                if (Object.keys(uniqueUsers).length === 0) {
                    activeUsersList.innerHTML = '<li class="text-revent-subtle text-sm">Нет зарегистрированных пользователей.</li>';
                }
                
            }, (error) => {
                console.error("Ошибка при получении списка пользователей:", error);
                addSystemMessageToDOM('❌ Ошибка загрузки списка пользователей.');
            });
        }

        // --- Инициализация Firebase ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Обязательная аутентификация через предоставленный токен или анонимный вход
                // для получения доступа к Firestore.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // onAuthStateChanged сработает после signInWithCustomToken/signInAnonymously
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        firebaseUserId = user.uid;
                        isAuthReady = true;
                        
                        // Если пользователь уже вошел в систему (например, из предыдущей сессии)
                        // В этом случае мы просто покажем модальное окно для входа.
                        addSystemMessageToDOM('✅ Firebase подключен. Требуется вход в приложение.');
                        
                        // Показываем модальное окно для кастомного входа/регистрации
                        showAuthModal();
                    } else {
                        // Это не должно произойти, если мы успешно вызываем signInWithCustomToken/signInAnonymously
                        console.error('Firebase Auth failed. Firestore access likely restricted.');
                        addSystemMessageToDOM('❌ Ошибка аутентификации Firebase. Нет доступа к базе данных.');
                    }
                });

            } catch (e) {
                console.error("Ошибка инициализации Firebase:", e);
                addSystemMessageToDOM(`❌ Не удалось инициализировать Firebase: ${e.message}`);
            }
        }

        window.onload = initFirebase;
        
    </script>
</body>
</html>
