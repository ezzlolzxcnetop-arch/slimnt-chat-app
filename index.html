<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revent Chat ‚Äî –ö–æ–ø–∏—è TG/Discord</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ FontAwesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∞–ª–∏—Ç—Ä—ã Revent (Indigo/Cyan Theme) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω (–≥–ª—É–±–æ–∫–∏–π –∏–Ω–¥–∏–≥–æ/—É–≥–æ–ª—å)
                        'revent-dark': '#1e1f29',
                        // –§–æ–Ω –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ / —á–∞—Ç–∞ (—á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ)
                        'revent-panel': '#282a36',
                        // –û—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç (–∫–∏–±–µ—Ä-—Å–∏–Ω–∏–π/—Ü–∏–∞–Ω)
                        'revent-accent': '#00bfff', // –Ø—Ä–∫–∏–π —Ü–∏–∞–Ω
                        // –í—Ç–æ—Ä–∏—á–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        'revent-active': '#4c5885',
                        // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
                        'revent-text': '#e0e0e0',
                        // –¶–≤–µ—Ç –±–æ–ª–µ–µ —Ç—É—Å–∫–ª–æ–≥–æ —Ç–µ–∫—Å—Ç–∞/—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
                        'revent-subtle': '#8f9ba8',
                        // –¶–≤–µ—Ç –¥–ª—è –æ—à–∏–±–æ–∫/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                        'revent-error': '#ff6347', // –ö–æ—Ä–∞–ª–ª–æ–≤—ã–π –¥–ª—è –æ—à–∏–±–æ–∫
                    },
                    boxShadow: {
                        // –ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π "–≥–ª–æ—É"
                        'glow': '0 0 10px rgba(0, 191, 255, 0.5), 0 0 20px rgba(0, 191, 255, 0.2)',
                        'glow-sm': '0 0 5px rgba(0, 191, 255, 0.4)',
                    }
                }
            }
        }
    </script>
    <style>
        /* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e1f29; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4c5885; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #00bfff; }

        /* –ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .glow-effect {
            transition: all 0.2s ease-in-out;
        }
        .glow-effect:hover {
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.6);
            filter: brightness(1.1);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –ö–Ω–æ–ø–∫–∏ –û—Ç–ø—Ä–∞–≤–∫–∏ (–°–∫—Ä–∏–Ω—à–æ—Ç 1) --- */
        #send-button-svg {
            width: 40px; 
            height: 40px; 
            background-color: #00bfff; /* –¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞ */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
        }
        
        /* –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É —Å—Ç—Ä–µ–ª–∫–∏ (—É–≥–æ–ª–∫–∞) —Å –ø–æ–º–æ—â—å—é clip-path */
        #send-button-svg {
            clip-path: polygon(0% 0%, 100% 50%, 0% 100%, 0% 80%, 20% 50%, 0% 20%);
        }

        /* –ß—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –≤ —Ü–µ–Ω—Ç—Ä–µ, –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ–π */
        #send-button-svg i {
            color: #1e1f29; /* –¢–µ–º–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∏–∫–æ–Ω–∫–∏ */
            position: relative;
            left: 2px; /* –°–¥–≤–∏–≥–∞–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É */
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        #send-button:not([disabled]):hover #send-button-svg {
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.8);
            transform: scale(1.05);
            background-color: #33ccff;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –º–µ–Ω—é (–°–∫—Ä–∏–Ω—à–æ—Ç 2) */
        #sliding-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #sliding-menu.open {
            transform: translateX(0);
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
        #message-input:focus {
            box-shadow: 0 0 8px rgba(0, 191, 255, 0.8);
            border-color: #00bfff !important;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞ (–ø—É–ª—å—Å–∞—Ü–∏—è) */
        @keyframes input-glow {
            0% { box-shadow: 0 0 0px rgba(0, 191, 255, 0.0); }
            50% { box-shadow: 0 0 5px rgba(0, 191, 255, 0.6); }
            100% { box-shadow: 0 0 0px rgba(0, 191, 255, 0.0); }
        }

        .typing-glow {
            animation: input-glow 1.5s infinite alternate;
        }
        
    </style>
</head>

<body class="bg-revent-dark text-revent-text flex h-screen antialiased overflow-hidden">

    <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) -->
    <div id="auth-overlay" class="fixed inset-0 bg-revent-dark bg-opacity-95 z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-pulse rounded-full h-12 w-12 border-t-2 border-b-2 border-revent-accent"></div>
        <p class="mt-4 text-lg text-revent-accent">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</p>

        <div id="auth-form-container" class="mt-8 p-8 bg-revent-panel rounded-2xl shadow-glow w-full max-w-md border border-revent-active">
            <h3 class="text-revent-text text-3xl font-bold mb-6 text-center" id="auth-title">–í—Ö–æ–¥</h3>
            
            <div id="error-message" class="text-revent-error text-center mb-4 p-3 border border-revent-error rounded-lg hidden"></div>

            <!-- –ò–ó–ú–ï–ù–ï–ù–û: –ü–æ–ª–µ –¥–ª—è –ª–æ–≥–∏–Ω–∞ -->
            <input type="text" id="auth-login" placeholder="–õ–æ–≥–∏–Ω (Admin: admin)" 
                   class="p-4 w-full border border-revent-subtle bg-revent-dark text-revent-text rounded-lg transition duration-150 ease-in-out shadow-inner mb-4 focus:shadow-glow focus:border-revent-accent">
            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" 
                   class="p-4 w-full border border-revent-subtle bg-revent-dark text-revent-text rounded-lg transition duration-150 ease-in-out shadow-inner mb-6 focus:shadow-glow focus:border-revent-accent">
            
            <button id="auth-submit" class="bg-revent-accent text-revent-dark p-4 rounded-lg w-full font-bold glow-effect text-lg">
                –í–æ–π—Ç–∏
            </button>
            
            <!-- –í–û–ó–í–†–ê–©–ï–ù–ê –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ -->
            <p class="text-center mt-4">
                <button id="toggle-auth-mode" class="text-revent-accent hover:text-revent-text text-sm transition duration-150">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </p>
        </div>
    </div>
    
    <!-- –°–∫–æ–ª—å–∑—è—â–µ–µ –ú–µ–Ω—é –ü—Ä–æ—Ñ–∏–ª—è (–°–∫—Ä–∏–Ω—à–æ—Ç 2) -->
    <div id="sliding-menu" class="fixed inset-y-0 left-0 w-72 bg-revent-panel z-40 p-6 border-r border-revent-accent/50 shadow-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-revent-text"><i class="fas fa-microchip mr-2 text-revent-accent"></i> –ü—Ä–æ—Ñ–∏–ª—å</h2>
            <button id="close-menu-button" class="text-revent-subtle hover:text-revent-accent text-3xl transition duration-150">
                &times;
            </button>
        </div>
        <div id="profile-card" class="flex flex-col items-center bg-revent-dark p-6 rounded-2xl shadow-glow-sm border-2 border-revent-active">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>

        <div class="mt-8 pt-4 border-t border-revent-active text-sm text-revent-subtle">
            <p class="mb-1">–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</p>
            <p class="mt-1">ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: <span id="app-id" class="font-mono text-xs text-revent-accent break-all"></span></p>
            <p class="mt-1">–†–æ–ª—å: <span id="user-role" class="font-bold text-revent-text">–ì–æ—Å—Ç—å</span></p>
        </div>
    </div>


    <div class="flex flex-row h-full w-full overflow-hidden">
        
        <!-- –ü–∞–Ω–µ–ª—å –°–ø–∏—Å–∫–∞ –ß–∞—Ç–æ–≤/–°–µ—Ä–≤–µ—Ä–æ–≤ (–°–ª–µ–≤–∞, —É–∑–∫–∞—è) -->
        <div id="chat-list-panel" class="flex flex-col w-20 sm:w-20 bg-revent-dark border-r border-revent-accent/30 p-2 shadow-xl">
            <!-- –õ–æ–≥–æ—Ç–∏–ø/–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≠–ª–µ–º–µ–Ω—Ç -->
            <div class="text-3xl font-extrabold text-revent-accent pt-2 pb-4 text-center">
                <i class="fas fa-satellite-dish shadow-glow-sm"></i>
            </div>
            <!-- –°–ø–∏—Å–æ–∫ –ß–∞—Ç–æ–≤/–°–µ—Ä–≤–µ—Ä–æ–≤ (–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω) -->
            <div id="chat-channel-list" class="flex flex-col space-y-3 mt-4 flex-1">
                <!-- –ö–∞–Ω–∞–ª 1: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –ö–∞–Ω–∞–ª (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <button class="bg-revent-accent/20 border border-revent-accent/80 text-revent-text p-3 rounded-xl glow-effect w-full h-16 flex items-center justify-center flex-col">
                    <i class="fas fa-terminal text-2xl mb-1"></i>
                    <span class="text-xs font-semibold">–°–∏—Å—Ç–µ–º–∞</span>
                </button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –û–±–ª–∞—Å—Ç—å –ß–∞—Ç–∞ -->
        <div class="flex-1 flex flex-col h-full bg-revent-panel">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ß–∞—Ç–∞ —Å –ö–Ω–æ–ø–∫–∞–º–∏ -->
            <div class="bg-revent-dark border-b border-revent-accent/50 p-3 shadow-2xl flex items-center justify-between">
                
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ö–Ω–æ–ø–∫–∞ –ü—Ä–æ—Ñ–∏–ª—è (–î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –º–µ–Ω—é) -->
                <button id="open-menu-button" class="text-revent-accent p-2 rounded-full transition duration-150 glow-effect bg-revent-panel shadow-glow-sm">
                    <i class="fas fa-user-circle text-2xl"></i>
                </button>
                
                <!-- –¶–µ–Ω—Ç—Ä: –ò–º—è –ö–∞–Ω–∞–ª–∞ -->
                <div class="flex items-center space-x-3">
                    <span class="text-lg font-bold text-revent-text">–°–∏—Å—Ç–µ–º–Ω—ã–π –ö–∞–Ω–∞–ª (Admin Chat)</span>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ö–Ω–æ–ø–∫–∏ –°–µ—Ä–≤–µ—Ä—ã / –î–æ–±–∞–≤–∏—Ç—å –î—Ä—É–≥–∞ -->
                <div class="flex items-center space-x-3 relative">
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞" (–±–µ–∑ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞) -->
                    <button class="text-revent-subtle hover:text-revent-accent p-2 rounded-full transition duration-150 glow-effect">
                        <i class="fas fa-user-plus text-xl"></i>
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ "–°–µ—Ä–≤–µ—Ä—ã" —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º –º–µ–Ω—é -->
                    <div class="relative">
                        <button id="server-dropdown-toggle" class="text-revent-accent p-2 rounded-full transition duration-150 glow-effect bg-revent-panel shadow-glow-sm">
                            <i class="fas fa-server text-xl"></i>
                        </button>
                        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é -->
                        <div id="server-dropdown" class="absolute right-0 mt-2 w-56 bg-revent-dark border border-revent-accent/50 rounded-lg shadow-glow p-2 hidden z-10">
                            <button id="create-server-btn" class="w-full text-left p-3 rounded-lg text-revent-text hover:bg-revent-active transition duration-150">
                                <i class="fas fa-plus-circle mr-2"></i> –°–æ–∑–¥–∞—Ç—å –°–µ—Ä–≤–µ—Ä
                            </button>
                            <button id="join-server-btn" class="w-full text-left p-3 rounded-lg text-revent-text hover:bg-revent-active transition duration-150">
                                <i class="fas fa-link mr-2"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ ID
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å –°–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                <div class="flex items-center justify-center h-full text-revent-subtle" id="initial-message">
                    <i class="fas fa-spinner fa-spin mr-2"></i> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –°–∏—Å—Ç–µ–º–Ω–æ–º—É –ö–∞–Ω–∞–ª—É...
                </div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å –í–≤–æ–¥–∞ –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="bg-revent-dark p-4 border-t border-revent-accent/50 shadow-inner">
                <div class="flex items-center space-x-3">
                    <!-- –ö–Ω–æ–ø–∫–∞ –ó–∞–≥—Ä—É–∑–∫–∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                    <label for="image-upload" class="cursor-pointer text-revent-subtle hover:text-revent-accent transition duration-150 glow-effect p-3 rounded-xl bg-revent-panel shadow-md">
                        <i class="fas fa-paperclip text-xl"></i>
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                    </label>

                    <!-- –ü–æ–ª–µ –í–≤–æ–¥–∞ -->
                    <!-- –ü—Ä–∏ –≤–≤–æ–¥–µ –±—É–¥–µ—Ç —Å–≤–µ—á–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ :focus CSS) - –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –±—É–∫–≤ -->
                    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                           class="flex-1 p-3 border border-revent-active bg-revent-panel text-revent-text rounded-xl transition duration-300 ease-in-out shadow-inner"
                           disabled>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –û—Ç–ø—Ä–∞–≤–∫–∏ (–°–∫—Ä–∏–Ω—à–æ—Ç 1) -->
                    <button id="send-button" 
                            class="transition duration-150 ease-in-out disabled:opacity-30 disabled:cursor-not-allowed"
                            disabled>
                        <div id="send-button-svg">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </div>
                    </button>
                </div>
                 <p id="auth-warning" class="text-revent-error text-center mt-2 hidden">
                    –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏.
                </p>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ ID –°–µ—Ä–≤–µ—Ä–∞ -->
    <div id="server-id-modal" class="fixed inset-0 bg-revent-dark bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="bg-revent-panel rounded-2xl w-full max-w-sm p-8 shadow-glow border-2 border-revent-accent/50">
            <h2 class="text-2xl font-bold text-revent-accent mb-6">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –°–µ—Ä–≤–µ—Ä—É</h2>
            <input type="text" id="server-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –°–µ—Ä–≤–µ—Ä–∞" 
                   class="p-3 w-full border border-revent-active bg-revent-dark text-revent-text rounded-lg transition duration-150 ease-in-out shadow-inner focus:shadow-glow">
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancel-join-server" class="bg-revent-subtle text-revent-dark p-3 rounded-lg font-bold glow-effect">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="confirm-join-server" class="bg-revent-accent text-revent-dark p-3 rounded-lg font-bold glow-effect" disabled>
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>


    <!-- –ú–æ–¥—É–ª–∏ Firebase –∏ –õ–æ–≥–∏–∫–∞ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // –î–æ–±–∞–≤–ª–µ–Ω createUserWithEmailAndPassword
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('debug'); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firebase

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –õ–æ–≥–∏–Ω–∞/–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
        const LOGIN_DOMAIN = '@revent.chat'; // –°–∫—Ä—ã—Ç—ã–π –¥–æ–º–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã Firebase
        const ADMIN_LOGIN = 'admin';
        const ADMIN_EMAIL = `${ADMIN_LOGIN}${LOGIN_DOMAIN}`; 
        let ADMIN_UID = null; 

        let app, db, auth;
        let userId = null;
        let messagesUnsubscribe = null;
        let isCurrentUserAdmin = false;
        let isSigningUp = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ: true = –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, false = –í—Ö–æ–¥

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const imageUpload = document.getElementById('image-upload');
        const profileCard = document.getElementById('profile-card');
        const authOverlay = document.getElementById('auth-overlay');
        const authTitle = document.getElementById('auth-title');
        // –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ auth-login
        const authLoginInput = document.getElementById('auth-login');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitButton = document.getElementById('auth-submit');
        const errorMessageDisplay = document.getElementById('error-message');
        const userRoleDisplay = document.getElementById('user-role');
        const slidingMenu = document.getElementById('sliding-menu');
        const authWarning = document.getElementById('auth-warning');
        const initialMessage = document.getElementById('initial-message');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode'); // –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞

        // --- –£—Ç–∏–ª–∏—Ç—ã ---
        
        function displayCustomAlert(message) {
            console.warn("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:", message);
        }

        function toggleInputGlow(isTyping) {
            if (isTyping) {
                messageInput.classList.add('typing-glow');
            } else {
                messageInput.classList.remove('typing-glow');
            }
        }
        
        // Helper: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –õ–æ–≥–∏–Ω –≤ Email –¥–ª—è Firebase
        function getAuthEmail(login) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –ª–æ–≥–∏–Ω –ê–¥–º–∏–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π email
            if (login === ADMIN_LOGIN) {
                return ADMIN_EMAIL;
            }
            // –ò–Ω–∞—á–µ, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à —Å–∫—Ä—ã—Ç—ã–π –¥–æ–º–µ–Ω
            return login.includes('@') ? login : `${login}${LOGIN_DOMAIN}`;
        }
        
        // Helper: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Email –≤ –õ–æ–≥–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function getAuthLogin(email) {
            if (!email) return 'N/A';
            return email.split(LOGIN_DOMAIN)[0] || email;
        }

        // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è ---
        async function handleLogout() {
            if (!auth) return;
            try {
                if (auth.currentUser.isAnonymous) {
                     await signInAnonymously(auth); 
                } else {
                    await signOut(auth);
                }
                authOverlay.classList.remove('hidden');
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã:", e);
                displayCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function renderProfile(uid, email) {
            const displayId = uid || 'N/A';
            const displayLogin = getAuthLogin(email);
            
            isCurrentUserAdmin = (uid && email === ADMIN_EMAIL);
            const roleText = isCurrentUserAdmin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            userRoleDisplay.textContent = roleText;

            const iconColorClass = isCurrentUserAdmin ? 'text-revent-error' : 'text-revent-accent';

            const profileHTML = `
                <div class="mb-4">
                    <i class="fas fa-user-circle text-7xl ${iconColorClass} shadow-glow-sm"></i>
                </div>
                <h3 class="text-lg font-bold text-revent-text">${roleText}:</h3>
                <p class="font-mono text-sm break-all bg-revent-active/50 p-2 rounded-lg mt-2 select-text shadow-glow-sm text-revent-text">
                    ${displayLogin}
                </p>
                <p class="text-xs text-revent-subtle mt-1 mb-6 break-all">
                    ID: ${displayId}
                </p>
                <!-- –ö–Ω–æ–ø–∫–∞ –í—ã—Ö–æ–¥ –∏–∑ –ü—Ä–æ—Ñ–∏–ª—è -->
                <button id="logout-button" 
                    class="w-full bg-revent-active text-revent-text p-3 rounded-xl shadow-lg hover:bg-revent-error transition duration-150 flex items-center justify-center space-x-2 font-semibold glow-effect">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>–í—ã—Ö–æ–¥</span>
                </button>
            `;
            profileCard.innerHTML = profileHTML;
            
            document.getElementById('logout-button')?.addEventListener('click', handleLogout);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π (–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            if (initialMessage) {
                initialMessage.remove(); 
            }

            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-revent-subtle mt-20">
                        <i class="fas fa-terminal text-5xl mb-4 text-revent-active"></i>
                        <p class="text-lg font-semibold">–ù–∞—á–∞–ª–æ –°–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ö–∞–Ω–∞–ª–∞</p>
                        <p class="text-sm">–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ—Ç —á–∞—Ç (–ø–æ–º–µ—á–µ–Ω –∫—Ä–∞—Å–Ω—ã–º). –í—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç—å.</p>
                    </div>
                `;
                return;
            }

            messages.forEach(msg => {
                const isSystemAdmin = msg.userId === ADMIN_UID;
                const isCurrentUser = msg.userId === userId;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–≥–∏–Ω –≤–º–µ—Å—Ç–æ email
                const senderLogin = msg.userEmail ? getAuthLogin(msg.userEmail) : '–ì–æ—Å—Ç—å';
                
                const senderName = isSystemAdmin ? '–°–∏—Å—Ç–µ–º–∞ (Admin)' : 
                                   (isCurrentUser ? '–í—ã' : senderLogin);

                const alignment = isCurrentUser ? 'justify-end' : 'justify-start';
                
                const isAccent = isSystemAdmin;
                const bgColor = isAccent ? 'bg-revent-error' : 'bg-revent-active';
                const textColor = isAccent ? 'text-revent-dark' : 'text-revent-text';
                
                const bubbleClass = isCurrentUser ? 'rounded-bl-xl' : 'rounded-br-xl';
                const shadowClass = isAccent ? 'shadow-lg shadow-revent-error/50' : 'shadow-md shadow-revent-dark/50 border border-revent-subtle/50';

                let contentHTML = '';
                if (msg.image) {
                    contentHTML = `
                        <a href="${msg.image}" target="_blank" class="block">
                            <img src="${msg.image}" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" 
                                 class="max-w-xs md:max-w-sm w-full h-auto rounded-lg mb-2 shadow-inner border border-revent-subtle object-cover transition transform hover:scale-[1.01] duration-300" 
                                 style="max-height: 250px;">
                        </a>
                    `;
                }

                if (msg.text) {
                    contentHTML += `<p class="whitespace-pre-wrap">${msg.text}</p>`;
                }
                
                let timeStr = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                if (msg.timestamp && msg.timestamp.seconds) {
                    const date = new Date(msg.timestamp.seconds * 1000);
                    timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                }

                const messageHTML = `
                    <div class="flex ${alignment}">
                        <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'} max-w-xs md:max-w-md lg:max-w-lg">
                            <div class="text-xs ${isCurrentUser ? 'text-revent-subtle' : 'text-revent-subtle'} mb-1 px-1">
                                ${senderName}
                            </div>
                            <div class="p-4 ${bgColor} ${textColor} rounded-t-xl ${bubbleClass} ${shadowClass} transition duration-300 ease-in-out break-words">
                                ${contentHTML}
                            </div>
                            <span class="text-xs text-revent-subtle mt-1">${timeStr}</span>
                        </div>
                    </div>
                `;
                messagesContainer.innerHTML += messageHTML;
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
        async function sendMessage(text = null, imageBase64 = null) {
            if (!db || !userId) return;

            const trimmedText = text ? text.trim() : '';
            if (!trimmedText && !imageBase64) return;
            
            if (!isCurrentUserAdmin) {
                displayCustomAlert("–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª.");
                messageInput.value = '';
                return;
            }

            const collectionPath = `artifacts/${appId}/public/data/admin_chat`; 

            try {
                if (imageBase64) {
                    // ... (–ª–æ–≥–∏–∫–∞ Base64 –ø—Ä–æ–ø—É—â–µ–Ω–∞ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
                }
                
                const newMessage = {
                    userId: userId,
                    userEmail: auth.currentUser.email || 'anonymous',
                    timestamp: serverTimestamp(),
                };
                
                if (trimmedText) {
                    newMessage.text = trimmedText;
                }
                if (imageBase64) {
                    newMessage.image = imageBase64;
                }

                await addDoc(collection(db, collectionPath), newMessage);

                messageInput.value = '';
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ", error);
                displayCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –°–º. –∫–æ–Ω—Å–æ–ª—å.");
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
        async function handleImageUpload(event) {
            if (!isCurrentUserAdmin) {
                displayCustomAlert("–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª.");
                imageUpload.value = '';
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                displayCustomAlert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 5MB.");
                imageUpload.value = '';
                return;
            }

            try {
                messageInput.placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...";
                
                const base64Data = await fileToBase64(file);
                await sendMessage(null, base64Data);
                imageUpload.value = '';
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", error);
                displayCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
            } finally {
                 messageInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
            }
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ File –≤ Base64 (–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }


        // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–ª–æ–≥–∏–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
        function listenForMessages() {
            if (messagesUnsubscribe) {
                messagesUnsubscribe(); 
            }
            
            const collectionPath = `artifacts/${appId}/public/data/admin_chat`;
            const q = query(collection(db, collectionPath), orderBy('timestamp', 'asc'));

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp || { seconds: Date.now() / 1000 }
                }));
                renderMessages(messages);
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
                messagesContainer.innerHTML = `<div class="text-center text-revent-error mt-20">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞. ${error.message}</div>`;
            });
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –†–µ–∂–∏–º–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
        function toggleAuthMode() {
            isSigningUp = !isSigningUp;
            errorMessageDisplay.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            
            if (isSigningUp) {
                authTitle.textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è";
                authSubmitButton.textContent = "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç";
                toggleAuthModeButton.textContent = "–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏";
                authLoginInput.placeholder = "–õ–æ–≥–∏–Ω (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤)";
            } else {
                authTitle.textContent = "–í—Ö–æ–¥";
                authSubmitButton.textContent = "–í–æ–π—Ç–∏";
                toggleAuthModeButton.textContent = "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
                authLoginInput.placeholder = "–õ–æ–≥–∏–Ω (Admin: admin)";
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
        async function handleAuthSubmit() {
            const login = authLoginInput.value.trim();
            const password = authPasswordInput.value.trim();
            const email = getAuthEmail(login); // –ü–æ–ª—É—á–∞–µ–º email –¥–ª—è Firebase
            errorMessageDisplay.classList.add('hidden');
            
            if (!login || !password) {
                errorMessageDisplay.textContent = "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.";
                errorMessageDisplay.classList.remove('hidden');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ª–æ–≥–∏–Ω–∞
            if (login.length < 3) {
                errorMessageDisplay.textContent = "–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤.";
                errorMessageDisplay.classList.remove('hidden');
                return;
            }

            try {
                if (isSigningUp) {
                    // –†–µ–∂–∏–º –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    if (password.length < 6) {
                         errorMessageDisplay.textContent = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.";
                         errorMessageDisplay.classList.remove('hidden');
                         return;
                    }
                    await createUserWithEmailAndPassword(auth, email, password);
                    
                } else {
                    // –†–µ–∂–∏–º –í—Ö–æ–¥–∞
                    await signInWithEmailAndPassword(auth, email, password);
                }
                
                // –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞ onAuthStateChanged –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–µ

            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ ${isSigningUp ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' : '–í—Ö–æ–¥–∞'}:`, error);
                let message = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.";
                
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    message = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.";
                } else if (error.code === 'auth/email-already-in-use') {
                    message = "–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ.";
                } else if (error.code === 'auth/weak-password') {
                    message = "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π. –û–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.";
                } else {
                    message = `–û—à–∏–±–∫–∞: ${error.message} (–ö–æ–¥: ${error.code}).`;
                }
                
                errorMessageDisplay.textContent = message;
                errorMessageDisplay.classList.remove('hidden');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                document.getElementById('app-id').textContent = appId;

                // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ADMIN_UID (–µ—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)
                if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                    await signInAnonymously(auth); 
                }

                // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è onAuthStateChanged
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –∫–∞–∫ –ê–¥–º–∏–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ UID –∫–∞–∫ ADMIN_UID
                        if (user.email === ADMIN_EMAIL) {
                             ADMIN_UID = user.uid;
                             console.log(`–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–π UID —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${ADMIN_UID}`);
                        }

                        isCurrentUserAdmin = (userId === ADMIN_UID);
                        
                        if (user.isAnonymous) {
                            // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤—Ö–æ–¥–∞
                            authOverlay.classList.remove('hidden');
                            messageInput.disabled = true;
                            sendButton.disabled = true;
                            authWarning.classList.remove('hidden');
                            renderProfile(null, '–ù–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
                            
                        } else {
                            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                            authOverlay.classList.add('hidden');
                            messageInput.disabled = false;
                            sendButton.disabled = !messageInput.value.trim() || !isCurrentUserAdmin; 
                            authWarning.classList.add('hidden');
                            renderProfile(userId, user.email);
                        }
                        
                        listenForMessages();

                    } else {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
                        userId = null;
                        messageInput.disabled = true;
                        sendButton.disabled = true;
                        authWarning.classList.remove('hidden');
                        renderProfile(null, '–ù–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
                        
                        authOverlay.classList.remove('hidden'); 
                    }
                });

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                messagesContainer.innerHTML = `<div class="text-center text-revent-error mt-20">üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase. –°–º. –∫–æ–Ω—Å–æ–ª—å.</div>`;
                authOverlay.classList.remove('hidden');
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---

        function handleInput() {
            toggleInputGlow(messageInput.value.length > 0);
            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–∫—Ç–∏–≤–Ω–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ê–¥–º–∏–Ω
            sendButton.disabled = !messageInput.value.trim() || !isCurrentUserAdmin; 
        }

        function handleSend(event) {
            event.preventDefault();
            if (isCurrentUserAdmin) {
                sendMessage(messageInput.value);
                messageInput.focus(); 
            } else {
                displayCustomAlert("–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤ —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª.");
            }
        }
        
        // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –º–µ–Ω—é
        document.getElementById('open-menu-button').addEventListener('click', () => {
            slidingMenu.classList.add('open');
        });

        document.getElementById('close-menu-button').addEventListener('click', () => {
            slidingMenu.classList.remove('open');
        });
        
        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –°–µ—Ä–≤–µ—Ä–æ–≤ (Server Dropdown)
        const serverDropdownToggle = document.getElementById('server-dropdown-toggle');
        const serverDropdown = document.getElementById('server-dropdown');
        serverDropdownToggle.addEventListener('click', () => {
            serverDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
            if (!serverDropdownToggle.contains(event.target) && !serverDropdown.contains(event.target)) {
                serverDropdown.classList.add('hidden');
            }
        });
        
        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –°–µ—Ä–≤–µ—Ä—É
        const serverIdModal = document.getElementById('server-id-modal');
        const serverIdInput = document.getElementById('server-id-input');
        const confirmJoinServer = document.getElementById('confirm-join-server');

        document.getElementById('join-server-btn').addEventListener('click', () => {
            serverDropdown.classList.add('hidden');
            serverIdModal.classList.remove('hidden');
        });

        document.getElementById('cancel-join-server').addEventListener('click', () => {
            serverIdModal.classList.add('hidden');
        });
        
        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –°–æ–∑–¥–∞—Ç—å –°–µ—Ä–≤–µ—Ä (Placeholder)
        document.getElementById('create-server-btn').addEventListener('click', () => {
            serverDropdown.classList.add('hidden');
            displayCustomAlert("–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞: –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏.");
        });

        serverIdInput.addEventListener('input', () => {
            confirmJoinServer.disabled = !serverIdInput.value.trim();
        });

        confirmJoinServer.addEventListener('click', () => {
            const serverId = serverIdInput.value.trim();
            if (serverId) {
                displayCustomAlert(`–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${serverId}. –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.`);
                serverIdModal.classList.add('hidden');
                serverIdInput.value = '';
            }
        });
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤
        toggleAuthModeButton.addEventListener('click', toggleAuthMode);


        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.onload = function() {
            initializeAppAndAuth();
            
            messageInput.addEventListener('input', handleInput);
            sendButton.addEventListener('click', handleSend);
            
            // –í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
            authLoginInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') handleAuthSubmit();
            });
            authPasswordInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') handleAuthSubmit();
            });

            authSubmitButton.addEventListener('click', handleAuthSubmit);
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendButton.disabled) {
                    handleSend(e);
                }
            });

            imageUpload.addEventListener('change', handleImageUpload);
        }
    </script>
</body>
</html>
