<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>slvent_</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∞–ª–∏—Ç—Ä—ã Revent --><script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω (–≥–ª—É–±–æ–∫–∏–π –∏–Ω–¥–∏–≥–æ/—É–≥–æ–ª—å)
                        'revent-dark': '#1e1f29',
                        // –§–æ–Ω –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ / —á–∞—Ç–∞ (—á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ)
                        'revent-panel': '#282a36',
                        // –û—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç (–∫–∏–±–µ—Ä-—Å–∏–Ω–∏–π/—Ü–∏–∞–Ω)
                        'revent-accent': '#00bfff', // –Ø—Ä–∫–∏–π —Ü–∏–∞–Ω
                        // –í—Ç–æ—Ä–∏—á–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        'revent-active': '#4c5885',
                        // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
                        'revent-text': '#e0e0e0',
                        // –¶–≤–µ—Ç –±–æ–ª–µ–µ —Ç—É—Å–∫–ª–æ–≥–æ —Ç–µ–∫—Å—Ç–∞/—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
                        'revent-subtle': '#8f9ba8',
                        // –¶–≤–µ—Ç –¥–ª—è –æ—à–∏–±–æ–∫/–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
                        'revent-error': '#ff6347', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                },
            }
        }
    </script>
    <style>
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #555555;
            border-radius: 20px;
            border: 2px solid #272727;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —á–∞—Ç-–ø—É–∑—ã—Ä–µ–π */
        .message-bubble {
            transition: opacity 0.2s;
        }
        .message-bubble:hover {
            opacity: 0.95;
        }

        /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –≤—ã—Å–æ—Ç—É */
        html, body, #app {
            height: 100%;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è particles.js –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        #particles-js {
            position: fixed; /* –ó–∞–∫—Ä–µ–ø–ª—è–µ–º —Ñ–æ–Ω */
            width: 100%;
            height: 100%;
            background-color: '#1e1f29'; /* –§–æ–Ω–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è particles.js */
            background-image: url('');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: 50% 50%;
            z-index: 0; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–∑–∞–¥–∏ */
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —á–∞—Ç–∞, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–æ–≤–µ—Ä—Ö particles.js */
        #app-content {
            position: relative; /* –ß—Ç–æ–±—ã z-index —Ä–∞–±–æ—Ç–∞–ª */
            z-index: 1; /* –ü–æ–≤–µ—Ä—Ö —á–∞—Å—Ç–∏—Ü */
            height: 100%;
            display: flex; /* –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ flex –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è #app */
            flex-direction: column; /* –ï—Å–ª–∏ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–∏–¥–∞ */
        #voice-view {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .voice-participant {
            transition: background-color 0.2s;
        }
        .voice-participant:hover {
            background-color: rgba(76, 88, 133, 0.2);
        }
        .mic-active {
            color: #10b981 !important;
        }
        .mic-muted {
            color: #ef4444 !important;
        }
    </style>
</head>
<body class="bg-revent-dark font-sans text-revent-text h-screen overflow-hidden">

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è particles.js —Ñ–æ–Ω–∞ --><div id="particles-js"></div>

    <!-- –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —á–∞—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–≤–µ—Ä—Ö particles.js --><div id="app-content" class="h-full flex">

        <!-- –≠–ö–†–ê–ù –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò / –ó–ê–ì–†–£–ó–ö–ò (–í–ò–î–ï–ù –°–ù–ê–ß–ê–õ–ê) --><div id="auth-view" class="h-full w-full absolute top-0 left-0 flex items-center justify-center bg-revent-dark/90 z-20">
            
            <!-- –§–æ—Ä–º–∞ –í—Ö–æ–¥–∞ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ --><div id="auth-card" class="bg-revent-panel p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition duration-500 ease-in-out scale-100">
                <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-revent-accent">–í—Ö–æ–¥ –≤ slax_</h2>
                
                <form id="auth-form">
                    <div class="mb-4">
                        <label for="auth-email" class="block text-sm font-medium text-revent-subtle mb-1">Email</label>
                        <input type="email" id="auth-email" name="email" required placeholder="name@example.com"
                               class="w-full p-3 rounded-lg bg-revent-active/30 text-revent-text placeholder-revent-subtle focus:outline-none focus:ring-2 focus:ring-revent-accent border border-transparent focus:border-revent-accent/50">
                    </div>
                    <div class="mb-6">
                        <label for="auth-password" class="block text-sm font-medium text-revent-subtle mb-1">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="auth-password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                               class="w-full p-3 rounded-lg bg-revent-active/30 text-revent-text placeholder-revent-subtle focus:outline-none focus:ring-2 focus:ring-revent-accent border border-transparent focus:border-revent-accent/50">
                    </div>
                    
                    <button type="submit" id="auth-submit-btn" class="w-full bg-revent-accent text-black font-semibold p-3 rounded-lg hover:bg-revent-accent/80 transition duration-300 shadow-lg shadow-revent-accent/30 flex items-center justify-center space-x-2">
                        <span id="auth-btn-text">–í–æ–π—Ç–∏</span>
                        <!-- –°–ø–∏–Ω–Ω–µ—Ä (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
                        <svg id="auth-spinner" class="animate-spin h-5 w-5 text-black hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    
                    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ --><p id="auth-error-message" class="mt-4 text-center text-revent-error text-sm hidden"></p>
                </form>

                <!-- –ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥ (–ù–æ–≤—ã–π –±–ª–æ–∫) --><div class="mt-4 pt-4 border-t border-revent-active/50">
                    <button id="guest-login-btn" onclick="window.signInAsGuest()" class="w-full bg-revent-active/50 text-revent-text font-semibold p-3 rounded-lg hover:bg-revent-active transition duration-300 flex items-center justify-center space-x-2">
                        <span id="guest-btn-text">–í–æ–π—Ç–∏ –∫–∞–∫ –ì–æ—Å—Ç—å</span>
                        <!-- –°–ø–∏–Ω–Ω–µ—Ä –¥–ª—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –≤—Ö–æ–¥–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —à–∞–±–ª–æ–Ω) -->
                        <svg id="guest-spinner" class="animate-spin h-5 w-5 text-revent-text hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="auth-switch-link" class="text-revent-subtle hover:text-revent-text text-sm transition duration-150">
                        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="font-bold text-revent-accent">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                    </button>
                </div>
            </div>
            
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥ —á–∞—Ç–∞ (–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) --><div id="chat-view" class="flex h-full w-full hidden">

            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤/—á–∞—Ç–æ–≤) --><div id="sidebar" class="w-64 bg-revent-panel/90 flex flex-col shadow-xl flex-shrink-0 backdrop-blur-sm relative z-10">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ / –ü—Ä–æ—Ñ–∏–ª—å --><div class="p-4 border-b border-revent-active flex items-center justify-between">
                    <span class="text-xl font-bold text-revent-text">slax_</span>
                    <span id="auth-status" class="text-revent-accent text-sm">–û–Ω–ª–∞–π–Ω</span>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∫–∞–Ω–∞–ª–æ–≤ --><div id="channel-list" class="flex-grow p-2 custom-scroll overflow-y-auto">
                    <!-- –ì—Ä—É–ø–ø–∞: –û—Å–Ω–æ–≤–Ω–æ–µ --><div class="mt-4">
                        <h3 class="text-xs font-semibold uppercase text-revent-subtle px-2 mb-1">–û–±—â–µ–µ</h3>
                        <div data-channel="general" class="channel-item p-2 rounded-lg cursor-pointer flex items-center space-x-2 active bg-revent-active text-revent-text" onclick="changeChannel('general', this)">
                            <span class="text-revent-accent">#</span>
                            <span class="truncate">–æ–±—â–∏–π-—á–∞—Ç</span>
                        </div>
                        <div data-channel="announcements" class="channel-item p-2 rounded-lg cursor-pointer flex items-center space-x-2 hover:bg-revent-active/20 text-revent-subtle" onclick="changeChannel('announcements', this)">
                            <span class="text-revent-subtle">#</span>
                            <span class="truncate">–Ω–æ–≤–æ—Å—Ç–∏</span>
                        </div>
                    </div>

                    <!-- –ì—Ä—É–ø–ø–∞: –ü—Ä–æ–µ–∫—Ç—ã --><div class="mt-4">
                        <h3 class="text-xs font-semibold uppercase text-revent-subtle px-2 mb-1">–ü—Ä–æ–µ–∫—Ç—ã</h3>
                        <div data-channel="frontend" class="channel-item p-2 rounded-lg cursor-pointer flex items-center space-x-2 hover:bg-revent-active/20 text-revent-subtle" onclick="changeChannel('frontend', this)">
                            <span class="text-revent-subtle">#</span>
                            <span class="truncate">frontend-dev</span>
                        </div>
                        <div data-channel="design" class="channel-item p-2 rounded-lg cursor-pointer flex items-center space-x-2 hover:bg-revent-active/20 text-revent-subtle" onclick="changeChannel('design', this)">
                            <span class="text-revent-subtle">#</span>
                            <span class="truncate">–¥–∏–∑–∞–π–Ω</span>
                        </div>
                    </div>

                    <!-- –ì—Ä—É–ø–ø–∞: –ì–æ–ª–æ—Å–æ–≤—ã–µ --><div class="mt-4">
                        <h3 class="text-xs font-semibold uppercase text-revent-subtle px-2 mb-1">–ì–æ–ª–æ—Å–æ–≤—ã–µ</h3>
                        <div class="p-2 rounded-lg flex items-center space-x-2 text-revent-subtle hover:bg-revent-active/20 cursor-pointer voice-channel-item" onclick="joinVoiceChannel('room1', this)">
                             <!-- –ò–∫–æ–Ω–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö) --><svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-2 3v-3H4a2 2 0 01-2-2V5z"></path></svg>
                            <span class="truncate">–ö–æ–º–Ω–∞—Ç–∞ 1</span>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å) --><div class="p-3 bg-revent-active/30 border-t border-revent-active/50 flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-revent-accent flex items-center justify-center font-bold text-black text-sm" id="user-avatar">G</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-sm truncate" id="user-display-name">–ì–æ—Å—Ç—å</div>
                        <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                        <button id="logout-button" onclick="window.handleLogout()" class="text-xs text-revent-error hover:text-red-300 transition duration-150">
                            –í—ã—Ö–æ–¥
                        </button>
                        <div class="text-xs text-revent-subtle truncate" id="user-display-id"></div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ --><div class="flex-1 flex flex-col bg-revent-dark/80 backdrop-blur-sm relative z-10">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ (–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞) --><div class="p-4 border-b border-revent-active/50 bg-revent-panel/90 shadow-md flex-shrink-0 flex justify-between items-center">
                    <h1 id="chat-title" class="text-xl font-bold flex items-center space-x-2">
                        <span class="text-revent-accent text-lg font-mono">#</span>
                        <span>–æ–±—â–∏–π-—á–∞—Ç</span>
                    </h1>
                    <!-- –ö–Ω–æ–ø–∫–∞ "–°–≤–æ–¥–∫–∞ —á–∞—Ç–∞" (Gemini) -->
                    <button id="summary-button" onclick="window.summarizeChannel()" class="bg-revent-active/50 text-revent-text text-sm font-medium py-1 px-3 rounded-full hover:bg-revent-accent/20 transition duration-300 flex items-center space-x-1 disabled:opacity-50">
                        <span id="summary-text">‚ú® –°–≤–æ–¥–∫–∞ —á–∞—Ç–∞</span>
                        <svg id="summary-spinner" class="animate-spin h-4 w-4 text-revent-text hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π --><div id="messages-container" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scroll">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JS / Firestore --></div>

                <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è --><div class="p-4 bg-revent-panel/90 border-t border-revent-active/50 flex-shrink-0">
                    <form id="message-form" class="flex space-x-3">
                        <button type="button" class="text-revent-subtle hover:text-revent-accent transition duration-150" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                            <!-- –ò–∫–æ–Ω–∫–∞ "–ø–ª—é—Å" --><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ "–ß–µ—Ä–Ω–æ–≤–∏–∫" (Draft Improvement) -->
                        <button type="button" id="draft-button" onclick="window.improveDraft()" class="text-revent-subtle hover:text-revent-accent transition duration-150 flex items-center justify-center px-1" title="–£–ª—É—á—à–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ (Gemini)">
                            <span class="text-lg">‚ú®</span>
                        </button>

                        <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ #–æ–±—â–∏–π-—á–∞—Ç" class="flex-grow p-3 rounded-full bg-revent-active/30 text-revent-text placeholder-revent-subtle focus:outline-none focus:ring-2 focus:ring-revent-accent transition duration-300 border border-transparent focus:border-revent-accent/50" autocomplete="off">
                        <button type="submit" class="bg-revent-accent text-black font-semibold p-3 rounded-full hover:bg-revent-accent/80 transition duration-300 shadow-lg shadow-revent-accent/30 flex items-center justify-center">
                            <!-- –ò–∫–æ–Ω–∫–∞ "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å" --><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183 0.183l7.001-3.5 7 3.5a1 1 0 00.183-.183l-7-14z"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            <!-- –í–∏–¥ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (–Ω–æ–≤—ã–π, –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
            <div id="voice-view" class="flex-1 flex flex-col bg-revent-dark/80 backdrop-blur-sm relative z-10 hidden">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ -->
                <div class="p-4 border-b border-revent-active/50 bg-revent-panel/90 shadow-md flex-shrink-0 flex justify-between items-center">
                    <h1 id="voice-title" class="text-xl font-bold flex items-center space-x-2">
                        <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-2 3v-3H4a2 2 0 01-2-2V5z"></path></svg>
                        <span>–ö–æ–º–Ω–∞—Ç–∞ 1</span>
                    </h1>
                    <button id="leave-voice-btn" onclick="leaveVoiceChannel()" class="bg-revent-error text-white text-sm font-medium py-1 px-3 rounded-full hover:bg-red-600 transition duration-300">
                        –ü–æ–∫–∏–Ω—É—Ç—å
                    </button>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                <div id="voice-participants" class="flex-grow p-4 space-y-2 overflow-y-auto custom-scroll">
                    <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–º -->
                <div class="p-4 bg-revent-panel/90 border-t border-revent-active/50 flex-shrink-0 flex items-center justify-center space-x-4">
                    <button id="mic-toggle-btn" onclick="toggleMic()" class="p-3 rounded-full bg-revent-active/50 hover:bg-revent-active transition duration-300 flex items-center justify-center">
                        <svg id="mic-icon" class="w-6 h-6 text-revent-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                    <button onclick="toggleSpeaker()" class="p-3 rounded-full bg-revent-active/50 hover:bg-revent-active transition duration-300 flex items-center justify-center">
                        <svg class="w-6 h-6 text-revent-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                    </button>
                    <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–¥–ª—è WebRTC) -->
                    <div id="connection-status" class="text-sm text-revent-subtle">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ particles.js --><script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è particles.js
        particlesJS('particles-js', {
            "particles": {
                "number": {
                    "value": 80,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": ["#00bfff", "#8f9ba8", "#e0e0e0"] // –¶–≤–µ—Ç–∞ —Ç–æ—á–µ–∫ (–∞–∫—Ü–µ–Ω—Ç, —Å—É–±—Ç–ª, —Ç–µ–∫—Å—Ç)
                },
                "shape": {
                    "type": "circle",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "polygon": {
                        "nb_sides": 5
                    }
                },
                "opacity": {
                    "value": 0.5,
                    "random": false,
                    "anim": {
                        "enable": false,
                        "speed": 1,
                        "opacity_min": 0.1,
                        "sync": false
                    }
                },
                "size": {
                    "value": 3,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 0.1,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#4c5885", // –¶–≤–µ—Ç –ª–∏–Ω–∏–π (–∞–∫—Ç–∏–≤–Ω—ã–π/–≤—Ç–æ—Ä–∏—á–Ω—ã–π)
                    "opacity": 0.4,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 2, // –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü
                    "direction": "none",
                    "random": false,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true,
                        "mode": "grab" // –¢–æ—á–∫–∏ –±—É–¥—É—Ç –ø—Ä–∏—Ç—è–≥–∏–≤–∞—Ç—å—Å—è –∫ –∫—É—Ä—Å–æ—Ä—É
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "push" // –ü—Ä–∏ –∫–ª–∏–∫–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 140,
                        "line_linked": {
                            "opacity": 1 // –õ–∏–Ω–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —è—Ä—á–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                        }
                    },
                    "bubble": {
                        "distance": 400,
                        "size": 40,
                        "duration": 2,
                        "opacity": 8,
                        "speed": 3
                    },
                    "repulse": {
                        "distance": 200,
                        "duration": 0.4
                    },
                    "push": {
                        "particles_nb": 4
                    },
                    "remove": {
                        "particles_nb": 2
                    }
                }
            },
            "retina_detect": true
        });
    </script>


    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // –î–æ–±–∞–≤–ª–µ–Ω signInAnonymously –¥–ª—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –≤—Ö–æ–¥–∞
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- UI Constants ---
        const MESSAGES_CONTAINER = document.getElementById('messages-container');
        const MESSAGE_FORM = document.getElementById('message-form');
        const MESSAGE_INPUT = document.getElementById('message-input');
        const CHAT_TITLE = document.getElementById('chat-title');
        const CHANNEL_LIST = document.getElementById('channel-list');
        const CHAT_VIEW = document.getElementById('chat-view');
        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        const AUTH_VIEW = document.getElementById('auth-view'); 
        const USER_DISPLAY_NAME = document.getElementById('user-display-name');
        const USER_DISPLAY_ID = document.getElementById('user-display-id');
        const USER_AVATAR = document.getElementById('user-avatar');
        
        // –ù–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è UI –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        const AUTH_FORM = document.getElementById('auth-form');
        const AUTH_TITLE = document.getElementById('auth-title');
        const AUTH_EMAIL_INPUT = document.getElementById('auth-email');
        const AUTH_PASSWORD_INPUT = document.getElementById('auth-password');
        const AUTH_SUBMIT_BTN = document.getElementById('auth-submit-btn');
        const AUTH_BTN_TEXT = document.getElementById('auth-btn-text');
        const AUTH_SPINNER = document.getElementById('auth-spinner');
        const AUTH_ERROR_MESSAGE = document.getElementById('auth-error-message');
        const AUTH_SWITCH_LINK = document.getElementById('auth-switch-link');
        
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –≤—Ö–æ–¥–∞
        const GUEST_LOGIN_BTN = document.getElementById('guest-login-btn');
        const GUEST_BTN_TEXT = document.getElementById('guest-btn-text');
        const GUEST_SPINNER = document.getElementById('guest-spinner');


        // –ù–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è Gemini API —Ñ—É–Ω–∫—Ü–∏–π
        const DRAFT_BUTTON = document.getElementById('draft-button');
        const SUMMARY_BUTTON = document.getElementById('summary-button');
        const SUMMARY_SPINNER = document.getElementById('summary-spinner');
        const SUMMARY_TEXT = document.getElementById('summary-text');

        // –ù–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        const VOICE_VIEW = document.getElementById('voice-view');
        const VOICE_PARTICIPANTS = document.getElementById('voice-participants');
        const VOICE_TITLE = document.getElementById('voice-title');
        const LEAVE_VOICE_BTN = document.getElementById('leave-voice-btn');
        const MIC_TOGGLE_BTN = document.getElementById('mic-toggle-btn');
        const MIC_ICON = document.getElementById('mic-icon');
        const CONNECTION_STATUS = document.getElementById('connection-status');


        // --- Firebase Globals (Updated with user's specific keys) ---
        // –ò–°–ü–û–õ–¨–ó–£–ï–ú –í–ê–®–£ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyB4wB9Y4U0NpqWDQ0_Iw5B4-ARcXCv_MFY",
          authDomain: "reventchat.firebaseapp.com",
          projectId: "reventchat",
          storageBucket: "reventchat.firebasestorage.app",
          messagingSenderId: "559607678515",
          appId: "1:559607678515:web:857c2ae7d06abc775dc546"
        };
        const appId = firebaseConfig.appId; 
        const initialAuthToken = null; 


        let app, db, auth;
        let currentChannel = 'general';
        let currentUserId = null;
        let currentUserName = '–ì–æ—Å—Ç—å';
        let unsubscribeMessageListener = null;
        let unsubscribeVoiceListener = null; // –î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        let isRegisterMode = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã: false = –í—Ö–æ–¥, true = –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        let currentVoiceRoom = null;
        let isMicMuted = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        let localStream = null; // –î–ª—è WebRTC (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
        
        // --- Gemini API Globals ---
        const API_KEY = "";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const MAX_RETRIES = 5;
        
        // --- TTS Globals ---
        let audioPlayer = null; // HTML Audio element for simple playback
        const TTS_API_MODEL = "gemini-2.5-flash-preview-tts";
        const TTS_VOICE_NAME = "Kore"; 
        const PCM_SAMPLE_RATE = 24000; 


        // --- Voice Channel Functions ---

        /**
         * –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ.
         */
        window.joinVoiceChannel = async function(roomId, element) {
            if (!currentUserId) {
                addSystemMessageToDOM('‚ùå –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—É.');
                return;
            }

            currentVoiceRoom = roomId;
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º –∫–∞–Ω–∞–ª
            document.querySelectorAll('.voice-channel-item').forEach(item => {
                item.classList.remove('active', 'bg-revent-active', 'text-revent-text');
                item.classList.add('hover:bg-revent-active/20', 'text-revent-subtle');
            });
            element.classList.add('active', 'bg-revent-active', 'text-revent-text');
            element.classList.remove('hover:bg-revent-active/20', 'text-revent-subtle');

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥ –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–æ–π
            CHAT_VIEW.querySelector('.flex-1.flex.flex-col').classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç
            VOICE_VIEW.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–∏–¥

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–º–Ω–∞—Ç—É (Firestore)
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/voice_rooms/${roomId}/users`, currentUserId), {
                    userId: currentUserId,
                    userName: currentUserName,
                    joinedAt: serverTimestamp(),
                    isSpeaking: false, // –î–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ —Ä–µ—á–∏ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
                    micMuted: isMicMuted
                });
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                listenForVoiceParticipants(roomId);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC (–∑–∞–≥–ª—É—à–∫–∞ - –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ PeerJS –∏–ª–∏ Socket.io)
                initVoiceConnection(roomId);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                CONNECTION_STATUS.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                addSystemMessageToDOM(`üé§ –í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomId}".`); // –í—Ä–µ–º–µ–Ω–Ω–æ –≤ —á–∞—Ç, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π UI
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ:', error);
                addSystemMessageToDOM('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ.');
            }
        };

        /**
         * –ü–æ–∫–∏–Ω—É—Ç—å –≥–æ–ª–æ—Å–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É.
         */
        window.leaveVoiceChannel = function() {
            if (!currentVoiceRoom) return;
            
            // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
            deleteDoc(doc(db, `artifacts/${appId}/public/data/voice_rooms/${currentVoiceRoom}/users`, currentUserId)).catch(console.error);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è
            if (unsubscribeVoiceListener) {
                unsubscribeVoiceListener();
                unsubscribeVoiceListener = null;
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —á–∞—Ç—É
            VOICE_VIEW.classList.add('hidden');
            CHAT_VIEW.querySelector('.flex-1.flex.flex-col').classList.remove('hidden');
            currentVoiceRoom = null;
            CONNECTION_STATUS.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
            document.querySelectorAll('.voice-channel-item').forEach(item => {
                item.classList.remove('active', 'bg-revent-active', 'text-revent-text');
                item.classList.add('hover:bg-revent-active/20', 'text-revent-subtle');
            });
        };

        /**
         * –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã.
         */
        function listenForVoiceParticipants(roomId) {
            if (unsubscribeVoiceListener) {
                unsubscribeVoiceListener();
            }

            const voiceQuery = query(collection(db, `artifacts/${appId}/public/data/voice_rooms/${roomId}/users`));
            
            unsubscribeVoiceListener = onSnapshot(voiceQuery, (snapshot) => {
                VOICE_PARTICIPANTS.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    addVoiceParticipantToDOM(data.userName, data.userId === currentUserId, data.micMuted || false);
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                VOICE_TITLE.innerHTML = `<svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-2 3v-3H4a2 2 0 01-2-2V5z"></path></svg>
                    <span>–ö–æ–º–Ω–∞—Ç–∞ 1 (${snapshot.size} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)</span>`;
            }, (error) => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã:', error);
            });
        }

        /**
         * –î–æ–±–∞–≤–ª—è–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ DOM –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–∏–¥–∞.
         */
        function addVoiceParticipantToDOM(username, isMe, micMuted) {
            const participantDiv = document.createElement('div');
            participantDiv.className = `voice-participant p-3 rounded-lg bg-revent-panel/50 flex items-center space-x-3`;
            
            const avatar = document.createElement('div');
            avatar.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${isMe ? 'bg-revent-accent text-black' : 'bg-revent-active text-revent-text/80'}`;
            avatar.textContent = username.charAt(0).toUpperCase();
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-semibold flex-1 truncate';
            nameSpan.textContent = username;
            
            const micIcon = document.createElement('svg');
            micIcon.className = `w-5 h-5 ${micMuted ? 'mic-muted' : 'mic-active'}`;
            micIcon.setAttribute('fill', 'currentColor');
            micIcon.setAttribute('viewBox', '0 0 20 20');
            micIcon.innerHTML = '<path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-2 3v-3H4a2 2 0 01-2-2V5z"></path>';
            
            participantDiv.appendChild(avatar);
            participantDiv.appendChild(nameSpan);
            participantDiv.appendChild(micIcon);
            
            VOICE_PARTICIPANTS.appendChild(participantDiv);
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω.
         */
        window.toggleMic = function() {
            isMicMuted = !isMicMuted;
            MIC_ICON.classList.toggle('mic-muted', isMicMuted);
            MIC_ICON.classList.toggle('mic-active', !isMicMuted);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Firestore
            if (currentVoiceRoom) {
                setDoc(doc(db, `artifacts/${appId}/public/data/voice_rooms/${currentVoiceRoom}/users`, currentUserId), {
                    micMuted: isMicMuted
                }, { merge: true }).catch(console.error);
            }
            
            // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏–æ: localStream.getAudioTracks()[0].enabled = !isMicMuted;
        };

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞ - —Ä–∞—Å—à–∏—Ä—å—Ç–µ –¥–ª—è P2P).
         */
        function initVoiceConnection(roomId) {
            // TODO: –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ–ª–Ω—ã–π WebRTC —Å signaling —á–µ—Ä–µ–∑ Firestore –∏–ª–∏ Socket.io
            // –ü—Ä–∏–º–µ—Ä: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PeerJS –∏–ª–∏ native RTCPeerConnection
            console.log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã ${roomId}`);
            // –ó–∞–≥–ª—É—à–∫–∞: navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { localStream = stream; });
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞).
         */
        window.toggleSpeaker = function() {
            // TODO: –†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞—É–¥–∏–æ-–≤—ã—Ö–æ–¥–∞
            console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–æ–≤');
        };


        // --- Helper Functions for TTS (unchanged) ---

        // Helper to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper to convert PCM 16-bit data to WAV format (Blob)
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1; // Mono
            const bitsPerSample = 16;
            const blockAlign = numChannels * (bitsPerSample / 8);
            const byteRate = sampleRate * blockAlign;
            const dataLength = pcmData.length * 2; // Int16Array length * 2 bytes/sample

            const buffer = new ArrayBuffer(44 + dataLength);
            const dataView = new DataView(buffer);
            let offset = 0;

            // RIFF chunk
            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    dataView.setUint8(offset + i, s.charCodeAt(i));
                }
                offset += s.length;
            }

            writeString('RIFF');
            dataView.setUint32(offset, 36 + dataLength, true); offset += 4; // File size - 8
            writeString('WAVE');

            // FMT chunk
            writeString('fmt ');
            dataView.setUint32(offset, 16, true); offset += 4; // Sub-chunk size (16 for PCM)
            dataView.setUint16(offset, 1, true); offset += 2; // Audio Format (1 for PCM)
            dataView.setUint16(offset, numChannels, true); offset += 2; // Number of channels
            dataView.setUint32(offset, sampleRate, true); offset += 4; // Sample Rate
            dataView.setUint32(offset, byteRate, true); offset += 4; // Byte Rate
            dataView.setUint16(offset, blockAlign, true); offset += 2; // Block Align
            dataView.setUint16(offset, bitsPerSample, true); offset += 2; // Bits per sample

            // Data chunk
            writeString('data');
            dataView.setUint32(offset, dataLength, true); offset += 4; // Data size

            // Write PCM data
            const pcmView = new Int16Array(buffer, offset);
            pcmView.set(pcmData);
            
            return new Blob([buffer], { type: 'audio/wav' });
        }


        // --- UI Helper Functions ---
        
        /**
         * –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
         * @param {boolean} isGuest - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, –≥–æ—Å—Ç–µ–≤–∞—è –ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞.
         */
        function showLoading(isGuest = false) {
            if (isGuest) {
                GUEST_SPINNER.classList.remove('hidden');
                GUEST_BTN_TEXT.classList.add('hidden');
                GUEST_LOGIN_BTN.disabled = true;
            } else {
                AUTH_SPINNER.classList.remove('hidden');
                AUTH_BTN_TEXT.classList.add('hidden');
                AUTH_SUBMIT_BTN.disabled = true;
            }
            AUTH_ERROR_MESSAGE.classList.add('hidden');
            GUEST_LOGIN_BTN.disabled = true; // –û—Ç–∫–ª—é—á–∞–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞
            AUTH_SUBMIT_BTN.disabled = true; 
        }

        /**
         * –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
         */
        function hideLoading() {
            AUTH_SPINNER.classList.add('hidden');
            AUTH_BTN_TEXT.classList.remove('hidden');
            AUTH_SUBMIT_BTN.disabled = false;
            
            GUEST_SPINNER.classList.add('hidden');
            GUEST_BTN_TEXT.classList.remove('hidden');
            GUEST_LOGIN_BTN.disabled = false;
        }

        function showFormError(message) {
            AUTH_ERROR_MESSAGE.textContent = message;
            AUTH_ERROR_MESSAGE.classList.remove('hidden');
            // –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => AUTH_ERROR_MESSAGE.classList.add('hidden'), 5000);
        }
        
        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –º–µ–∂–¥—É –í—Ö–æ–¥–æ–º –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.
         */
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            AUTH_FORM.reset(); // –°–±—Ä–æ—Å –ø–æ–ª–µ–π
            AUTH_ERROR_MESSAGE.classList.add('hidden');

            if (isRegisterMode) {
                AUTH_TITLE.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                AUTH_BTN_TEXT.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                AUTH_SWITCH_LINK.innerHTML = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span class="font-bold text-revent-accent">–í–æ–π—Ç–∏</span>';
            } else {
                AUTH_TITLE.textContent = '–í—Ö–æ–¥ –≤ slax_';
                AUTH_BTN_TEXT.textContent = '–í–æ–π—Ç–∏';
                AUTH_SWITCH_LINK.innerHTML = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span class="font-bold text-revent-accent">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>';
            }
        }
        
        // --- Firebase Setup and Authentication ---

        async function setupFirebase() {
            setLogLevel('Debug');
            
            if (!firebaseConfig.projectId || !firebaseConfig.apiKey) {
                // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                 document.getElementById('auth-card').innerHTML = `<div class="p-4 text-center">
                                                    <p class="text-xl text-red-400 font-bold">err firebase(tell admin)</p>
                                                    <p class="text-revent-subtle mt-2">err key</p>
                                                </div>`;
                return;
            }
            
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    let displayId;

                    if (user.isAnonymous) {
                        // –õ–û–ì–ò–ö–ê –î–õ–Ø –ì–û–°–¢–Ø
                        currentUserName = `–ì–æ—Å—Ç—å-${user.uid.substring(0, 5)}`;
                        displayId = `ID: ${user.uid.substring(0, 8)}...`;
                        
                        USER_AVATAR.textContent = 'G';
                        USER_AVATAR.classList.remove('bg-revent-accent', 'text-black');
                        USER_AVATAR.classList.add('bg-revent-active', 'text-revent-text/80');

                    } else {
                        // –õ–û–ì–ò–ö–ê –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø EMAIL/PASSWORD
                        currentUserName = user.displayName || user.email.split('@')[0] || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-${user.uid.substring(0, 5)}`;
                        displayId = user.email;

                        USER_AVATAR.textContent = currentUserName.charAt(0).toUpperCase();
                        USER_AVATAR.classList.remove('bg-revent-active', 'text-revent-text/80');
                        USER_AVATAR.classList.add('bg-revent-accent', 'text-black');
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    USER_DISPLAY_NAME.textContent = currentUserName;
                    USER_DISPLAY_ID.textContent = displayId;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç, —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    AUTH_VIEW.classList.add('hidden');
                    CHAT_VIEW.classList.remove('hidden');

                    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
                    listenForMessages(currentChannel);

                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                    AUTH_VIEW.classList.remove('hidden');
                    CHAT_VIEW.classList.add('hidden');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    if (unsubscribeMessageListener) {
                        unsubscribeMessageListener();
                        unsubscribeMessageListener = null;
                    }
                    MESSAGES_CONTAINER.innerHTML = '';
                    currentUserId = null;
                    hideLoading(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏
                    // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–∏–¥
                    VOICE_VIEW.classList.add('hidden');
                    CHAT_VIEW.querySelector('.flex-1.flex.flex-col').classList.remove('hidden');
                }
            });
        }
        
        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í—Ö–æ–¥ –∏–ª–∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ Email/Password.
         */
        AUTH_FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = AUTH_EMAIL_INPUT.value.trim();
            const password = AUTH_PASSWORD_INPUT.value.trim();

            if (password.length < 6) {
                showFormError("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.");
                return;
            }
            
            showLoading(false); // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è email/password

            try {
                if (isRegisterMode) {
                    // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è (–±–µ—Ä–µ–º —á–∞—Å—Ç—å email –¥–æ @)
                    const displayName = email.split('@')[0];
                    await updateProfile(userCredential.user, { displayName: displayName });
                    
                    // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ onAuthStateChanged —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç UI
                } else {
                    // –í–•–û–î
                    await signInWithEmailAndPassword(auth, email, password);
                    // –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ onAuthStateChanged —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç UI
                }

            } catch (error) {
                console.error("Auth Error:", error);
                
                let errorMessage;
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å.";
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = "–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤).";
                        break;
                    default:
                        errorMessage = `–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message.substring(0, 50)}...`;
                        break;
                }
                
                showFormError(errorMessage);
            } finally {
                hideLoading();
            }
        });

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥ –∫–∞–∫ –≥–æ—Å—Ç—å (–∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è).
         */
        window.signInAsGuest = async function() {
            showLoading(true); // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –≥–æ—Å—Ç–µ–≤–æ–≥–æ –≤—Ö–æ–¥–∞
            try {
                // –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥
                await signInAnonymously(auth);
                // onAuthStateChanged —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç UI
            } catch (error) {
                console.error("Guest Sign-in Error:", error);
                showFormError("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            } finally {
                hideLoading();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤
        AUTH_SWITCH_LINK.addEventListener('click', toggleAuthMode);
        
        /**
         * –í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
         */
        window.handleLogout = async function() {
             try {
                await signOut(auth);
                // onAuthStateChanged —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–∫–∞–∂–µ—Ç —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
             } catch (error) {
                console.error("Logout Error:", error);
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–π—Ç–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ —á–∞—Ç–µ
                addSystemMessageToDOM(`‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ${error.message}`);
             }
        }


        // --- Firestore Logic (unchanged) ---

        function getChannelPath(channelId) {
            // –ü—É—Ç—å –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: /artifacts/{appId}/public/data/messages_{channelId}
            return `artifacts/${appId}/public/data/messages_${channelId}`;
        }

        function listenForMessages(channelId) {
            if (unsubscribeMessageListener) {
                unsubscribeMessageListener(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞
            }

            const messagesQuery = query(
                collection(db, getChannelPath(channelId))
                // Firestore. Note: Avoiding orderBy here to prevent index requirement errors.
            );

            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            MESSAGES_CONTAINER.innerHTML = '';

            // –°–ª—É—à–∞—Ç–µ–ª—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            unsubscribeMessageListener = onSnapshot(messagesQuery, (snapshot) => {
                MESSAGES_CONTAINER.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º

                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({
                        id: doc.id,
                        user: data.user || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π',
                        text: data.text,
                        timestamp: data.timestamp ? data.timestamp.toMillis() : 0, // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
                        userId: data.userId
                    });
                });

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –º–µ—Ç–∫–µ –≤—Ä–µ–º–µ–Ω–∏
                messages.sort((a, b) => a.timestamp - b.timestamp);

                // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                messages.forEach(msg => {
                    const isMe = msg.userId === currentUserId;
                    const timeStr = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '??:??';
                    addMessageToDOM(msg.user, msg.text, timeStr, isMe);
                });

            }, (error) => {
                console.error("Error listening to messages:", error);
                MESSAGES_CONTAINER.innerHTML = `<div class="text-center text-red-400 mt-10">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.</div>`;
            });
        }

        // --- DOM Manipulation (unchanged) ---
        
        // Helper: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ DOM
        function addMessageToDOM(username, text, time, isMine) {
            const container = document.createElement('div');
            container.className = `flex ${isMine ? 'justify-end' : 'justify-start'} items-start space-x-3 message-bubble`;
            
            // –ê–≤–∞—Ç–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            if (!isMine) {
                const avatar = document.createElement('div');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ—Å—Ç–µ–º –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                const isGuest = username.startsWith('–ì–æ—Å—Ç—å-');
                avatar.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0 ${
                    isGuest 
                    ? 'bg-revent-active text-revent-text/80' 
                    : 'bg-revent-accent text-black'
                }`;
                avatar.textContent = username.charAt(0).toUpperCase();
                container.appendChild(avatar);
            }

            // –ü—É–∑—ã—Ä—å —Å–æ–æ–±—â–µ–Ω–∏—è
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-lg relative ${
                isMine 
                ? 'bg-revent-accent text-black rounded-br-none' 
                : 'bg-revent-panel text-revent-text rounded-tl-none'
            }`;

            // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            if (!isMine) {
                const user = document.createElement('span');
                user.className = 'font-semibold text-revent-accent block text-sm mb-1';
                user.textContent = username;
                bubble.appendChild(user);
            }

            // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageText = document.createElement('p');
            messageText.className = 'text-sm whitespace-pre-wrap break-words';
            messageText.innerHTML = text.replace(/\n/g, '<br>'); // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫
            bubble.appendChild(messageText);

            // –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
            const timeStamp = document.createElement('div');
            timeStamp.className = `text-xs mt-1 text-right ${isMine ? 'text-black/60' : 'text-revent-subtle'}`;
            timeStamp.textContent = time;
            bubble.appendChild(timeStamp);
            
            // –ö–Ω–æ–ø–∫–∞ TTS
            const ttsButton = document.createElement('button');
            ttsButton.className = `absolute -right-10 top-0.5 text-revent-subtle hover:text-green-400 transition duration-150 p-1 rounded-full ${isMine ? 'hidden' : ''}`;
            ttsButton.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.879-3.879a1 1 0 011.09-.045zM14.07 7.07a1 1 0 011.666 1.057 4.194 4.194 0 000 4.746 1 1 0 01-1.666 1.057 6.194 6.194 0 010-6.86zm3.54-1.92a1 1 0 011.597 1.259 8.194 8.194 0 000 9.122 1 1 0 01-1.597 1.259 10.194 10.194 0 010-11.64z" clip-rule="evenodd"></path></svg>`;
            ttsButton.title = "–ü—Ä–æ—Å–ª—É—à–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
            ttsButton.onclick = () => window.playTts(text, ttsButton);
            bubble.appendChild(ttsButton);


            container.appendChild(bubble);

            // –ê–≤–∞—Ç–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            if (isMine) {
                const avatar = document.createElement('div');
                 // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∏–ª–∏ –∏–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
                avatar.className = `w-8 h-8 rounded-full bg-revent-accent flex items-center justify-center font-bold text-sm text-black flex-shrink-0`;
                avatar.textContent = username.charAt(0).toUpperCase();
                container.appendChild(avatar);
            }
            
            MESSAGES_CONTAINER.appendChild(container);
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            MESSAGES_CONTAINER.scrollTop = MESSAGES_CONTAINER.scrollHeight;
        }

        // Helper: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ) —Å–æ–æ–±—â–µ–Ω–∏—è
        function addSystemMessageToDOM(text) {
             const container = document.createElement('div');
             container.className = 'flex justify-center my-4';
             
             const messageBox = document.createElement('div');
             messageBox.className = 'text-center text-sm text-revent-subtle bg-revent-active/30 p-2 rounded-lg max-w-sm';
             messageBox.innerHTML = text.replace(/\n/g, '<br>');
             
             container.appendChild(messageBox);
             MESSAGES_CONTAINER.appendChild(container);
             MESSAGES_CONTAINER.scrollTop = MESSAGES_CONTAINER.scrollHeight;
        }


        // --- Event Handlers (UI/Action) ---

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ (unchanged)
        window.changeChannel = function(newChannelId, element) {
            if (newChannelId === currentChannel) return;

            // –°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active', 'bg-revent-active', 'text-revent-text');
                item.classList.add('hover:bg-revent-active/20', 'text-revent-subtle');
            });
            element.classList.add('active', 'bg-revent-active', 'text-revent-text');
            element.classList.remove('hover:bg-revent-active/20', 'text-revent-subtle');

            currentChannel = newChannelId;
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            CHAT_TITLE.querySelector('span:last-child').textContent = element.querySelector('span:last-child').textContent;
            MESSAGE_INPUT.placeholder = `–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ #${element.querySelector('span:last-child').textContent}`;
            
            // –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            listenForMessages(currentChannel);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (unchanged)
        MESSAGE_FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = MESSAGE_INPUT.value.trim();

            if (text.length === 0 || !currentUserId) {
                return;
            }

            MESSAGE_INPUT.value = ''; // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            
            try {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞
                await addDoc(collection(db, getChannelPath(currentChannel)), {
                    text: text,
                    timestamp: serverTimestamp(),
                    user: currentUserName,
                    userId: currentUserId,
                });
            } catch (error) {
                console.error("Error sending message:", error);
                addSystemMessageToDOM(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                MESSAGE_INPUT.value = text;
            }
        });


        // --- Gemini API Logic (LLM for text/summary, TTS - unchanged) ---

        /**
         * Generic function to make an authenticated Gemini API call with exponential backoff.
         */
        async function makeApiCall(systemPrompt, userQuery, isJson = false) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            if (isJson) {
                 payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "improved_text": { "type": "STRING", "description": "The refined and professional version of the user's input text." }
                        }
                    }
                }
            }
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }

                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const textPart = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!textPart) {
                        throw new Error("Received empty or malformed response from API.");
                    }

                    if (isJson) {
                        try {
                            // LLM returns a stringified JSON object
                            const parsed = JSON.parse(textPart);
                            return parsed.improved_text;
                        } catch (e) {
                            console.error("Failed to parse JSON response (received text:):", textPart, e);
                            throw new Error("Failed to process structured response.");
                        }
                    }

                    return textPart;

                } catch (error) {
                    console.error("Gemini API Error (Attempt " + (i + 1) + "):", error);
                    if (i === MAX_RETRIES - 1) throw error; // Re-throw on last attempt
                }
            }
        }
        
        /**
         * –£–ª—É—á—à–∞–µ—Ç —Ç–µ–∫—Å—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é Gemini.
         */
        window.improveDraft = async function() {
            const text = MESSAGE_INPUT.value.trim();
            if (!text) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤–≤–æ–¥ –ø—É—Å—Ç
                MESSAGE_INPUT.placeholder = '–í–≤–µ–¥–∏—Ç–µ —á–µ—Ä–Ω–æ–≤–∏–∫, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å –µ–≥–æ.';
                setTimeout(() => MESSAGE_INPUT.placeholder = `–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ #${document.querySelector('.channel-item.active span:last-child').textContent}`, 2000);
                return;
            }

            DRAFT_BUTTON.disabled = true;
            DRAFT_BUTTON.innerHTML = '...'; // –ü—Ä–æ—Å—Ç–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

            try {
                const systemPrompt = "You are a professional writing assistant. Take the user's draft message, correct any grammatical errors, improve clarity, and adjust the tone to be professional and concise. Respond ONLY with the refined text inside a JSON object with the key 'improved_text'. The response must be in Russian.";
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º isJson=true –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
                const improvedText = await makeApiCall(systemPrompt, `Draft: "${text}"`, true);
                
                if (improvedText) {
                    MESSAGE_INPUT.value = improvedText;
                }

            } catch (error) {
                console.error("Error improving draft:", error);
                // –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                MESSAGE_INPUT.placeholder = '–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —É–ª—É—á—à–∏—Ç—å —Ç–µ–∫—Å—Ç.';
                setTimeout(() => MESSAGE_INPUT.placeholder = `–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ #${document.querySelector('.channel-item.active span:last-child').textContent}`, 3000);
            } finally {
                DRAFT_BUTTON.disabled = false;
                DRAFT_BUTTON.innerHTML = '<span class="text-lg">‚ú®</span>'; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            }
        }

        /**
         * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç.
         */
        window.summarizeChannel = async function() {
            SUMMARY_BUTTON.disabled = true;
            SUMMARY_TEXT.classList.add('hidden');
            SUMMARY_SPINNER.classList.remove('hidden');

            try {
                // 1. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π (–º–∞–∫—Å–∏–º—É–º)
                const messagesElements = MESSAGES_CONTAINER.querySelectorAll('.flex:not(.justify-center)'); // –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const lastMessages = Array.from(messagesElements).slice(-10);

                if (lastMessages.length === 0) {
                    addSystemMessageToDOM("‚ö†Ô∏è –í —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–≤–æ–¥–∫–∏.");
                    return;
                }

                // 2. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è LLM
                let conversationContext = `Channel: ${currentChannel}\n\n`;
                lastMessages.forEach(msgEl => {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—Å—Ç –∏–∑ DOM
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—Å—Ç–∞
                    const userEl = msgEl.querySelector('.font-semibold');
                    const textEl = msgEl.querySelector('p');
                    
                    if (textEl) {
                        const user = userEl ? userEl.textContent : (msgEl.classList.contains('justify-end') ? currentUserName : '–î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                        const text = textEl.textContent;
                        conversationContext += `${user}: ${text}\n`;
                    }
                });

                const systemPrompt = "You are an expert chat moderator. Your task is to provide a concise, high-level summary of the preceding conversation (last 10 messages) to quickly catch up new members. The summary should be objective, clear, and delivered in Russian.";
                
                const summary = await makeApiCall(systemPrompt, `Conversation context:\n\n${conversationContext}\n\nProvide a summary in Russian:`, false);

                // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –≤ —á–∞—Ç –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                addSystemMessageToDOM(`**‚ú® –°–≤–æ–¥–∫–∞ Gemini:** ${summary}`);

            } catch (error) {
                console.error("Error summarizing channel:", error);
                addSystemMessageToDOM("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤–æ–¥–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            } finally {
                SUMMARY_BUTTON.disabled = false;
                SUMMARY_TEXT.classList.remove('hidden');
                SUMMARY_SPINNER.classList.add('hidden');
            }
        }
        
        /**
         * Calls the TTS API to generate audio from text.
         */
        window.playTts = async function(text, button) {
            
            button.disabled = true;
            button.innerHTML = '...'; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }
            
            const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_API_MODEL}:generateContent`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: `Say in Russian: ${text}` }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: TTS_VOICE_NAME }
                            }
                        }
                    },
                };
                
                let apiResponse;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    const response = await fetch(`${ttsApiUrl}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }

                    if (!response.ok) {
                        throw new Error(`TTS API call failed with status: ${response.status}`);
                    }
                    
                    apiResponse = await response.json();
                    break;
                }

                if (!apiResponse) throw new Error("TTS API call failed.");

                const part = apiResponse?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ PCM16 –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã–µ.
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, PCM_SAMPLE_RATE);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ—ç–ª–µ–º–µ–Ω—Ç–∞
                    if (!audioPlayer) {
                        audioPlayer = new Audio();
                        audioPlayer.onended = () => {
                            button.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.879-3.879a1 1 0 011.09-.045zM14.07 7.07a1 1 0 011.666 1.057 4.194 4.194 0 000 4.746 1 1 0 01-1.666 1.057 6.194 6.194 0 010-6.86zm3.54-1.92a1 1 0 011.597 1.259 8.194 8.194 0 000 9.122 1 1 0 01-1.597 1.259 10.194 10.194 0 010-11.64z" clip-rule="evenodd"></path></svg>`;
                            button.disabled = false;
                        };
                    }
                    
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                    
                    // –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ "—Å—Ç–æ–ø/–ø–∞—É–∑–∞"
                    button.innerHTML = `<svg class="w-4 h-4 text-red-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>`;
                    
                } else {
                    addSystemMessageToDOM(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ.`);
                    throw new Error("Invalid audio data from TTS API.");
                }

            } catch (error) {
                console.error("TTS Playback Error:", error);
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.879-3.879a1 1 0 011.09-.045zM14.07 7.07a1 1 0 011.666 1.057 4.194 4.194 0 000 4.746 1 1 0 01-1.666 1.057 6.194 6.194 0 010-6.86zm3.54-1.92a1 1 0 011.597 1.259 8.194 8.194 0 000 9.122 1 1 0 01-1.597 1.259 10.194 10.194 0 010-11.64z" clip-rule="evenodd"></path></svg>`;
                button.disabled = false;
            } finally {
                // –ï—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å, –Ω–µ –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É. –û–Ω–∞ –æ—Ç–∫–ª—é—á–∏—Ç—Å—è –≤ onended.
                if (!audioPlayer || audioPlayer.paused || audioPlayer.ended) {
                    button.disabled = false;
                }
            }
        }


        // --- Initialization ---

        window.onload = setupFirebase;

    </script>
</body>
</html>