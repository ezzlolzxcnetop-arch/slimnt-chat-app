<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revent Chat — с Firebase и TTS</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Конфигурация Tailwind для кастомной цветовой палитры Revent
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'revent-dark': '#1e1f29',
                        'revent-panel': '#282a36',
                        'revent-accent': '#00bfff', // Яркий циан
                        'revent-active': '#4c5885',
                        'revent-text': '#e0e0e0',
                        'revent-subtle': '#8f9ba8',
                        'revent-error': '#ff6347',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Стиль для прокручиваемого контейнера сообщений */
        #messages-container {
            height: calc(100vh - 12rem); /* Высота с учетом заголовка и поля ввода */
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-bottom: 1rem;
        }

        /* Стиль для скроллбара (только для эстетики) */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4c5885;
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #1e1f29;
        }
    </style>
</head>
<body class="bg-revent-dark text-revent-text font-sans antialiased">

    <div class="flex flex-col h-screen max-w-4xl mx-auto">
        <!-- Заголовок / Панель пользователя -->
        <header class="p-4 bg-revent-panel shadow-lg rounded-b-xl flex justify-between items-center z-10">
            <h1 class="text-xl font-bold text-revent-accent">Revent Chat <span class="text-sm text-revent-subtle">| Global</span></h1>
            <div id="user-info" class="text-sm text-revent-text truncate max-w-[50%]">
                <span class="inline-block bg-revent-active px-3 py-1 rounded-full text-xs font-mono">
                    Loading User...
                </span>
            </div>
        </header>

        <!-- Контейнер для сообщений -->
        <main id="messages-container" class="flex-grow p-4 space-y-4">
            <!-- Сообщения будут добавлены сюда JavaScript'ом -->
            <div id="system-message" class="text-center text-revent-subtle pt-8">
                Соединение с Firebase...
            </div>
        </main>

        <!-- Форма ввода сообщения -->
        <footer class="p-4 bg-revent-panel shadow-2xl rounded-t-xl sticky bottom-0 z-10">
            <form id="message-form" class="flex gap-3">
                <input type="text" id="message-input" placeholder="Введите ваше сообщение..." required
                       class="flex-grow p-3 rounded-xl bg-revent-dark border border-revent-active focus:outline-none focus:ring-2 focus:ring-revent-accent text-revent-text placeholder-revent-subtle transition">
                <button type="submit" id="send-button"
                        class="bg-revent-accent text-revent-dark font-semibold py-3 px-5 rounded-xl hover:bg-opacity-90 transition duration-200 shadow-lg shadow-revent-accent/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l4.499-1.341c.823-.244 1.62-.485 2.5-1.124l5.65 3.39c.642.385 1.44-.061 1.44-.897V4.303a1 1 0 00-.772-.942l-9-3z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                </button>
            </form>
        </footer>
    </div>

    <!-- Firebase SDK и основной скрипт -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Глобальные переменные Canvas (ОБЯЗАТЕЛЬНО К ИСПОЛЬЗОВАНИЮ) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (!firebaseConfig) {
            console.error("Firebase config is missing. Cannot initialize Firebase.");
            document.getElementById('system-message').textContent = '❌ Ошибка: Конфигурация Firebase отсутствует.';
            return;
        }

        // --- Инициализация Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null;
        let authReady = false;

        // Включаем логирование для отладки
        setLogLevel('Debug');

        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const userInfoElement = document.getElementById('user-info');
        const sendButton = document.getElementById('send-button');

        // --- Вспомогательные функции ---

        // Конвертация PCM16 в WAV (НЕОБХОДИМА ДЛЯ TTS)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;

            const wavData = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(wavData);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);          // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true);           // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true);  // SampleRate
            view.setUint32(28, byteRate, true);    // ByteRate
            view.setUint16(32, blockAlign, true);  // BlockAlign
            view.setUint16(34, 16, true);          // BitsPerSample

            // DATA chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([wavData], { type: 'audio/wav' });

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
        }

        // Обработка TTS (Text-to-Speech)
        async function playTTS(text, button) {
            button.disabled = true;
            button.innerHTML = `<svg class="animate-spin w-4 h-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const ttsEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=`;
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" } // Выбираем голос
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(ttsEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    
                    audio.onended = () => {
                        // Восстанавливаем кнопку после окончания проигрывания
                        button.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.879-3.879a1 1 0 011.09-.045zM14.075 4.097a1 1 0 011.042 1.63L13.25 7.967A1 1 0 0113.25 12.033L15.117 14.27a1 1 0 01-1.042 1.63l-2.032-2.427A8.995 8.995 0 0110 16V4c.536 0 1.054.088 1.554.254l2.031-1.298a1 1 0 01.488-.119z" clip-rule="evenodd"></path></svg>`;
                        button.disabled = false;
                    };
                    audio.play();
                } else {
                    console.error("Не удалось сгенерировать аудио.");
                    alertMessage("❌ Не удалось сгенерировать аудио.", 'error');
                }
            } catch (error) {
                console.error("TTS Playback Error:", error);
                alertMessage("❌ Ошибка TTS. См. консоль.", 'error');
            } finally {
                // Восстанавливаем кнопку, если произошла ошибка до onended
                if (button.disabled && !button.innerHTML.includes('animate-spin')) {
                     button.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.879-3.879a1 1 0 011.09-.045zM14.075 4.097a1 1 0 011.042 1.63L13.25 7.967A1 1 0 0113.25 12.033L15.117 14.27a1 1 0 01-1.042 1.63l-2.032-2.427A8.995 8.995 0 0110 16V4c.536 0 1.054.088 1.554.254l2.031-1.298a1 1 0 01.488-.119z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>`;
                     button.disabled = false;
                }
            }
        }

        function createMessageElement(message) {
            const isSelf = message.userId === currentUserId;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

            const messageBox = document.createElement('div');
            messageBox.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl shadow-md flex flex-col ${isSelf ? 'bg-revent-accent text-revent-dark rounded-br-none' : 'bg-revent-panel text-revent-text rounded-tl-none'}`;

            // Никнейм/ID (только для чужих сообщений)
            if (!isSelf) {
                const userIdDisplay = document.createElement('span');
                userIdDisplay.className = 'text-xs font-semibold mb-1 text-revent-accent break-all';
                userIdDisplay.textContent = message.userId;
                messageBox.appendChild(userIdDisplay);
            }

            // Текст сообщения
            const messageText = document.createElement('p');
            messageText.className = 'text-sm break-words';
            messageText.textContent = message.text;
            messageBox.appendChild(messageText);

            // Время
            const timestamp = document.createElement('span');
            timestamp.className = `text-xs mt-1 ${isSelf ? 'text-revent-dark opacity-80' : 'text-revent-subtle'}`;
            const date = message.timestamp ? message.timestamp.toDate() : new Date();
            timestamp.textContent = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            messageBox.appendChild(timestamp);

            // Кнопка TTS
            const ttsButton = document.createElement('button');
            ttsButton.type = 'button';
            ttsButton.className = `absolute -top-3 ${isSelf ? '-left-8' : '-right-8'} p-1 rounded-full bg-revent-active/70 hover:bg-revent-active transition text-revent-text focus:outline-none shadow-lg`;
            ttsButton.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.414 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.414l3.879-3.879a1 1 0 011.09-.045zM14.075 4.097a1 1 0 011.042 1.63L13.25 7.967A1 1 0 0113.25 12.033L15.117 14.27a1 1 0 01-1.042 1.63l-2.032-2.427A8.995 8.995 0 0110 16V4c.536 0 1.054.088 1.554.254l2.031-1.298a1 1 0 01.488-.119z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>`;
            ttsButton.addEventListener('click', () => playTTS(message.text, ttsButton));

            const relativeContainer = document.createElement('div');
            relativeContainer.className = 'relative';
            relativeContainer.appendChild(messageBox);
            relativeContainer.appendChild(ttsButton);

            messageWrapper.appendChild(relativeContainer);
            return messageWrapper;
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Аутентификация и Наблюдение за Базой Данных ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Пользователь аутентифицирован
                currentUserId = user.uid;
                userInfoElement.innerHTML = `<span class="inline-block bg-revent-active px-3 py-1 rounded-full text-xs font-mono" title="Ваш ID пользователя">${currentUserId}</span>`;
                sendButton.disabled = false;
                messageInput.disabled = false;
                authReady = true;
                document.getElementById('system-message').remove(); // Убираем сообщение о загрузке
                
                // Начинаем слушать сообщения
                setupMessageListener();

            } else {
                // Пользователь не аутентифицирован, пробуем вход
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                        currentUserId = auth.currentUser.uid;
                        alertMessage("⚠️ Вход выполнен анонимно. Данные могут быть недоступны другим пользователям.", 'warning');
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    alertMessage("❌ Ошибка аутентификации. Чат не будет работать.", 'error');
                    sendButton.disabled = true;
                    messageInput.disabled = true;
                }
            }
        });

        // Основная функция для подписки на сообщения
        function setupMessageListener() {
            // Путь к коллекции: /artifacts/{appId}/public/data/messages
            const path = `artifacts/${appId}/public/data/messages`;
            const messagesCollection = collection(db, path);

            // Создаем запрос: все сообщения, отсортированные по времени
            // ВАЖНО: избегаем .orderBy() в запросе, сортируем на клиенте для совместимости с Canvas
            const q = query(messagesCollection); 

            onSnapshot(q, (snapshot) => {
                const newMessages = [];
                snapshot.forEach(doc => {
                    newMessages.push({ id: doc.id, ...doc.data() });
                });
                
                // Сортируем на стороне клиента по полю timestamp (если есть) или по дате
                newMessages.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeA - timeB;
                });

                messagesContainer.innerHTML = ''; // Очистка перед добавлением
                newMessages.forEach(msg => {
                    messagesContainer.appendChild(createMessageElement(msg));
                });

                scrollToBottom();
            }, (error) => {
                console.error("Ошибка при получении данных Firestore:", error);
                alertMessage("❌ Не удалось загрузить сообщения.", 'error');
            });
        }

        // --- Отправка сообщения ---
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (text === '' || !authReady || !currentUserId) return;

            try {
                const path = `artifacts/${appId}/public/data/messages`;
                await addDoc(collection(db, path), {
                    userId: currentUserId,
                    text: text,
                    timestamp: serverTimestamp() // Используем серверное время
                });
                messageInput.value = ''; // Очищаем поле ввода
            } catch (error) {
                console.error("Ошибка при отправке сообщения:", error);
                alertMessage("❌ Не удалось отправить сообщение.", 'error');
            }
        });

        // --- Временный модальный/системный алерт (вместо alert()) ---
        function alertMessage(message, type = 'info') {
            const id = 'alert-' + Date.now();
            const colorMap = {
                'info': 'bg-blue-900 border-blue-600',
                'warning': 'bg-yellow-900 border-yellow-600',
                'error': 'bg-red-900 border-red-600',
            };
            
            const alertHtml = `
                <div id="${id}" class="fixed top-4 right-4 max-w-sm p-4 rounded-xl border-l-4 shadow-lg z-50 transition-opacity duration-300 ${colorMap[type]}" role="alert">
                    <p class="text-sm font-medium text-revent-text">${message}</p>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);

            // Автоматическое удаление через 5 секунд
            setTimeout(() => {
                const element = document.getElementById(id);
                if (element) element.remove();
            }, 5000);
        }

    </script>

</body>
</html>
